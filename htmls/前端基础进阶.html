 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专栏</title>
    <style>
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */

* {
    font-size: 30px;
}

img{
    display: block;
    min-width: 50%;
}  
    </style>
</head>
<body>
<h1>【AAA货】前端Base64编码知识，一文打尽，探索起源，追求真相。</h1><h2 id="_1">前言</h2>
<p>本文收录在 <strong><a href="https://juejin.cn/column/6979380367216082957">前端基础进阶</a></strong> 专栏，欢迎关注和收藏, 往期经典：
* <a href="https://juejin.cn/column/6979380367216082957">【干货】私藏的这些高级工具函数，你拥有几个?</a>  400+ star
* <a href="https://juejin.cn/post/6978744007601946654">三千文字，也没写好 Function.prototype.call</a>   200+ star
* <a href="https://juejin.cn/post/6977239278145241101">那些你熟悉而又陌生的函数</a>  200+ star  <br />
* <a href="https://juejin.cn/post/6982742095375597575">这16种原生函数和属性的区别，你真的知道吗？ 精心收集，高级前端必备知识，快快打包带走</a>  100+ star</p>
<p><strong>收藏不star就是耍流氓！哈</strong></p>
<h2 id="_2">大纲</h2>
<p>方便移动端阅读：  </p>
<ul>
<li>Base64在前端的应用</li>
<li>Base64数据编码起源</li>
<li>Base64编码64的含义</li>
<li>Base64编码优缺点</li>
<li>一些计算机和前端基础知识</li>
<li>ASCII码， Unicode , UTF-8</li>
<li>Base64编码和解码</li>
<li>其他的成熟方案</li>
<li>写在最后</li>
</ul>
<h2 id="base64">Base64在前端的应用</h2>
<p>Base64编码，你一定知道的，先来看看她在前端的一些常见应用： <br />
当然绝部分场景都是基于<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs">Data URLs</a></p>
<h3 id="canvas">Canvas图片生成</h3>
<p>canvas的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLCanvasElement/toDataURL">toDataURL</a>可以把canvas的画布内容转base64编码格式包含图片展示的 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs">data URI</a>。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
<span class="c1">// ...... other code</span>
<span class="kd">const</span> <span class="nx">dataUrl</span> <span class="o">=</span> <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">();</span>

<span class="c1">// data:image/png;base64,iVBORw0KGgoAAAANSUhE.........</span>
</code></pre></div>

<p>你画我猜，新用户加入，要获取当前的最新的绘画界面，也可以通过Base64格式的消息传递。</p>
<h3 id="_3">文件读取</h3>
<p>FileReader的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/readAsDataURL">readAsDataURL</a>可以把上传的文件转为base64格式的data URI，比较常见的场景是用户头像的剪裁和上传。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">readAsDataURL</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">fileEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;inputFile&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
        <span class="nx">fd</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">fileEl</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mf">0</span><span class="p">]);</span>
        <span class="nx">fd</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">fd</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
            <span class="c1">// data:image/png;base64,iVBORw0KGgoAAAA.......</span>
        <span class="p">}</span>
        <span class="nx">fd</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">reject</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="jwt">jwt</h3>
<p>jwt由header, payload,signature三部分组成，前两个解码后，都是可以明文看见的。
拿 <a href="https://blog.csdn.net/u011277123/article/details/78918390">国服最强JWT生成Token做登录校验讲解，看完保证你学会！</a> 里面的token做测试。   </p>
<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79fa98d2c98347689d599235de5ddc0a~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_4">网站图片和小图片</h3>
<h4 id="_5">移动端网站图标优化</h4>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="nt">link</span> <span class="nt">rel</span><span class="o">=</span><span class="s2">&quot;icon&quot;</span> <span class="nt">href</span><span class="o">=</span><span class="s2">&quot;data:,&quot;</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="nt">link</span> <span class="nt">rel</span><span class="o">=</span><span class="s2">&quot;icon&quot;</span> <span class="nt">href</span><span class="o">=</span><span class="s2">&quot;data:;base64,=&quot;</span> <span class="o">/&gt;</span>
</code></pre></div>

<p>至于怎么获得这个值<code>data:,</code>的：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;0&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;0&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;canvas&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="kd">const</span> <span class="nx">canvasEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;canvas&quot;</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
    <span class="nx">dataUrl</span> <span class="o">=</span> <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dataUrl</span><span class="p">);</span>  <span class="c1">// data:,</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<h4 id="_6">小图片</h4>
<p>这个就有很多场景了，比如img标签，背景图等</p>
<p>img标签：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;data:image/png;base64,iVBORw0KGgoAAAA.......&quot;</span> <span class="p">/&gt;</span>
</code></pre></div>

<p>css背景图：</p>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="nc">bg</span><span class="p">{</span>
    <span class="k">background</span><span class="p">:</span> <span class="nb">url</span><span class="p">(</span><span class="sx">data:image/png;base64,iVBORw0KGgoAAAA.......</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_7">简单的数据加密</h3>
<p>当然这不是好方法，但是至少让你不好解读。   </p>
<div class="codehilite"><pre><span></span><code>  <span class="kd">const</span> <span class="nx">username</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">).</span><span class="nx">vlaue</span><span class="p">;</span> 
  <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">).</span><span class="nx">vlaue</span><span class="p">;</span>  
  <span class="kd">const</span> <span class="nx">secureKey</span> <span class="o">=</span> <span class="s2">&quot;%%S%$%DS)_sdsdj_66&quot;</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">sPass</span> <span class="o">=</span> <span class="nx">utf8_to_base64</span><span class="p">(</span><span class="nx">password</span> <span class="o">+</span> <span class="nx">secureKey</span><span class="p">);</span>

  <span class="nx">doLogin</span><span class="p">({</span>
      <span class="nx">username</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="nx">sPass</span>
  <span class="p">})</span>
</code></pre></div>

<h3 id="sourcemap">SourceMap</h3>
<p>借用阮大神的一段代码, 注意mappings字段，这实际上就是bas64编码格式的内容，当然你直接去解，是会失败的。</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
　　　　<span class="nx">version</span> <span class="o">:</span> <span class="mf">3</span><span class="p">,</span>
　　　　<span class="nx">file</span><span class="o">:</span> <span class="s2">&quot;out.js&quot;</span><span class="p">,</span>
　　　　<span class="nx">sourceRoot</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
　　　　<span class="nx">sources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;foo.js&quot;</span><span class="p">,</span> <span class="s2">&quot;bar.js&quot;</span><span class="p">],</span>
　　　　<span class="nx">names</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;maps&quot;</span><span class="p">,</span> <span class="s2">&quot;are&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">],</span>
　　　　<span class="nx">mappings</span><span class="o">:</span> <span class="s2">&quot;AAgBC,SAAQ,CAAEA&quot;</span>
　　<span class="p">}</span>
</code></pre></div>

<p>具体的实现请看官方的<a href="https://github.com/mozilla/source-map/blob/master/lib/base64-vlq.js">base64-vlq.js</a>文件。 </p>
<h3 id="_8">混淆加密代码</h3>
<p>著名的代码混淆库， <a href="https://github.com/javascript-obfuscator/javascript-obfuscator#javascript-obfuscator-options">javascript-obfuscator</a>，其也是有应用base64几码的，一起看看选项：<br />
<a href="https://github.com/javascript-obfuscator/webpack-obfuscator">webpack-obfuscator</a>也是基于其封装的。</p>
<div class="codehilite"><pre><span></span><code>    <span class="o">--</span><span class="nx">string</span><span class="o">-</span><span class="nx">array</span><span class="o">-</span><span class="nx">indexes</span><span class="o">-</span><span class="nx">type</span> <span class="s1">&#39;&lt;list&gt;&#39;</span> <span class="p">(</span><span class="nx">comma</span> <span class="nx">separated</span><span class="p">)</span> <span class="p">[</span><span class="nx">hexadecimal</span><span class="o">-</span><span class="nx">number</span><span class="p">,</span> <span class="nx">hexadecimal</span><span class="o">-</span><span class="nx">numeric</span><span class="o">-</span><span class="nx">string</span><span class="p">]</span>
    <span class="o">--</span><span class="nx">string</span><span class="o">-</span><span class="nx">array</span><span class="o">-</span><span class="nx">encoding</span> <span class="s1">&#39;&lt;list&gt;&#39;</span> <span class="p">(</span><span class="nx">comma</span> <span class="nx">separated</span><span class="p">)</span> <span class="p">[</span><span class="nx">none</span><span class="p">,</span> <span class="nx">base64</span><span class="p">,</span> <span class="nx">rc4</span><span class="p">]</span>
    <span class="o">--</span><span class="nx">string</span><span class="o">-</span><span class="nx">array</span><span class="o">-</span><span class="nx">index</span><span class="o">-</span><span class="nx">shift</span> <span class="o">&lt;</span><span class="kr">boolean</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="nx">string</span><span class="o">-</span><span class="nx">array</span><span class="o">-</span><span class="nx">wrappers</span><span class="o">-</span><span class="nx">count</span> <span class="o">&lt;</span><span class="nx">number</span><span class="o">&gt;</span>
    <span class="o">--</span><span class="nx">string</span><span class="o">-</span><span class="nx">array</span><span class="o">-</span><span class="nx">wrappers</span><span class="o">-</span><span class="nx">chained</span><span class="o">-</span><span class="nx">calls</span> <span class="o">&lt;</span><span class="kr">boolean</span><span class="o">&gt;</span>
</code></pre></div>

<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6efd8949a8484d87aa133f0f51213018~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_9">其他</h3>
<p>X.509公钥证书， github SSH key， mht文件，邮件附件等等，都有Base64的影子。</p>
<h2 id="base64_1">Base64数据编码起源</h2>
<p>早期邮件传输协议基于 ASCII 文本，对于诸如图片、视频等二进制文件处理并不好。
ASCII 主要用于显示<strong>现代英文</strong>，到目前为止只定义了 <strong>128</strong> 个字符，包含控制字符和可显示字符。
为了解决上述问题，Base64 编码顺势而生。</p>
<p>Base64是编解码，主要的作用不在于安全性，而在于让内容能在各个网关间无错的传输，这才是Base64编码的核心作用。</p>
<p>除了Base64数据编码，其实还有<strong>Base32数据编码, Base16数据编码</strong>，可以参见 <strong><a href="https://datatracker.ietf.org/doc/html/rfc4648">RFC 4648</a></strong>。</p>
<h2 id="base6464">Base64编码64的含义</h2>
<p>64就是64个字符的意思。</p>
<p>base64对照表， 借用 <a href="https://juejin.cn/post/6844903698045370376">Base64原理</a>的一张图：  <br />
<img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/58bd54e545664e52ace242d27216d84e~tplv-k3u1fbpfcp-watermark.image" /></p>
<ol>
<li><code>A-Z</code>  26</li>
<li><code>a-z</code>  26</li>
<li><code>0-9</code>  10</li>
<li><code>+ /</code>  2</li>
</ol>
<p><code>26 + 26 + 10 + 2</code>  = <code>64</code></p>
<p>当然还有一个字符<code>=</code>，这是填充字符，后面会提到，不属于64里面的范畴。</p>
<p>对照表的<strong>索引值</strong>，注意一下，后面的base64编码和解码会用到。</p>
<h2 id="base64_2">Base64编码优缺点</h2>
<h3 id="_10">优点</h3>
<ol>
<li>可以将二进制数据（比如图片）转化为可打印字符，方便传输数据</li>
<li>对数据进行简单的加密，肉眼是安全的</li>
<li>如果是在html或者css处理图片，可以减少http请求</li>
</ol>
<h3 id="_11">缺点</h3>
<ol>
<li>内容编码后体积变大， 至少1/3 <br />
     因为是三字节变成四个字节，当只有一个字节的时候，也至少会变成三个字节。</li>
<li>编码和解码需要额外工作量</li>
</ol>
<hr />
<p>说完优缺点，回到正题：</p>
<p>我们今天的重点是 uf8编码转Base64编码：</p>
<p><strong>基本流程</strong></p>
<blockquote>
<p>char =&gt; 码点 =&gt; utf-8编码 =&gt; base64编码</p>
</blockquote>
<p>在之前要解一下编码的知识, 了解编码知识，又要先了解一些计算机的基础知识。</p>
<h2 id="_12">一些计算机和前端基础知识</h2>
<h3 id="_13">比特和字节</h3>
<p><strong>比特又叫位</strong>。
在计算机的世界里，信息的表示方式只有 0 和 1, 其可以表示两种状态。 <br />
一位二进制可以表示两状态， N位可以表示<code>2^N</code>种状态。</p>
<p>一个字节<code>(Byte)</code>有8位<code>(Bit)</code>
<img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8e5f89053a314fa79be4194fa5b6d076~tplv-k3u1fbpfcp-watermark.image" /></p>
<p>所以一个字节可以表示 <code>2^8</code> = 256种状态；</p>
<h3 id="unicode">获得字符的 Unicode码点</h3>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/charCodeAt">String.prototype.charCodeAt</a> 可以获取字符的码点，获取范围为<code>0</code> ~ <code>65535</code>。 这个地方注意一下，关系到后面的utf-8字节数。</p>
<div class="codehilite"><pre><span></span><code><span class="s2">&quot;a&quot;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>  <span class="c1">// 97</span>
<span class="s2">&quot;中&quot;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span> <span class="c1">// 20013</span>
</code></pre></div>

<h3 id="_14">进制表示</h3>
<ol>
<li><code>0b</code>开头，可以表示二进制
注意<code>0b10000000</code>= 128 ,<code>0b11000000</code>=92，之后会用到.</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="mb">0b11111111</span> <span class="c1">// 255</span>
<span class="mb">0b10000000</span> <span class="c1">// 128 后面会用到</span>
<span class="mb">0b11000000</span> <span class="c1">// 192 后面会用到</span>
</code></pre></div>

<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25ba3d632c4e4e66ab662e4143683c73~tplv-k3u1fbpfcp-watermark.image" /></p>
<ol>
<li><code>0x</code>开头，可以表示16进制</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="mh">0x11111111</span> <span class="c1">// 286331153</span>
</code></pre></div>

<p><img alt="image.png" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40ada595a9c846bca205ec54d221f377~tplv-k3u1fbpfcp-watermark.image" /></p>
<p><code>0o</code>开头可以表示8进制，就不多说了，本来不会涉及。</p>
<h3 id="_15">进制转换</h3>
<p><strong>10进制转其他进制</strong> <br />
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/toString">Number.prototype.toString(radix)</a>可以把十进制转为其他进制。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">100.</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>  <span class="c1">// 1100100</span>
<span class="mf">100.</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">)</span> <span class="c1">// 64, 也等于 ox64</span>
</code></pre></div>

<p><strong>其他进制转为10进制</strong> <br />
<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/parseInt">parseInt(string, radix)</a>可以把其他进制，转为10进制。</p>
<div class="codehilite"><pre><span></span><code><span class="nb">parseInt</span><span class="p">(</span><span class="s2">&quot;10000000&quot;</span><span class="p">,</span> <span class="mf">2</span><span class="p">)</span> <span class="c1">// 128</span>
<span class="nb">parseInt</span><span class="p">(</span><span class="s2">&quot;10&quot;</span><span class="p">,</span><span class="mf">16</span><span class="p">)</span> <span class="c1">// 16</span>
</code></pre></div>

<p>这里额外提一下一元操作符号<code>+</code>可以把字符串转为数字，后面也会用到,之前提到的<code>0b</code>,<code>0o</code>,<code>0x</code>这里都会生效。</p>
<div class="codehilite"><pre><span></span><code><span class="o">+</span><span class="s2">&quot;1000&quot;</span> <span class="c1">// 1000</span>
<span class="o">+</span><span class="s2">&quot;0b10000000&quot;</span> <span class="c1">// 128</span>
<span class="o">+</span><span class="s2">&quot;0o10&quot;</span> <span class="c1">// 8</span>
<span class="o">+</span><span class="s2">&quot;0x10&quot;</span> <span class="c1">// 16</span>
</code></pre></div>

<h3 id="_16">位移操作</h3>
<p>本文只涉及<strong>右移</strong>操作，就只讲右移，右移相当于除以2，如果是整数，<strong>简单说是去低位</strong>，移动几位去掉几位，其实和10进制除以10是一样的。</p>
<p><code>64 &gt;&gt; 2 = 16</code>
我们一起看一下过程</p>
<div class="codehilite"><pre><span></span><code><span class="mf">0</span> <span class="mf">1</span> <span class="mf">0</span> <span class="mf">0</span> <span class="mf">0</span> <span class="mf">0</span> <span class="mf">0</span> <span class="mf">0</span>       <span class="mf">64</span>
<span class="o">-------------------</span>
   <span class="mf">0</span> <span class="mf">1</span> <span class="mf">0</span> <span class="mf">0</span> <span class="mf">0</span> <span class="mf">0</span> <span class="o">|</span> <span class="mf">0</span> <span class="mf">0</span>  <span class="mf">16</span>
</code></pre></div>

<h3 id="_17">一元 <code>&amp;</code> 操作和 一元<code>|</code>操作</h3>
<p><strong>一元&amp;</strong>   </p>
<p>当两者皆为1的时候，值为1。 <strong>本文的作用可用来去高位</strong>， 具体看代码。 <br />
<code>3553 &amp; 36</code> = <code>0b110111100001 &amp; 0b111111</code> = <code>100001</code> <br />
因为高位缺失，不可能都为1，故均为0,  而<strong>低位相当于复制一遍而已</strong>。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">110111</span> <span class="mf">100001</span>
       <span class="mf">111111</span>
<span class="o">------------</span>
<span class="mo">000000</span> <span class="mf">100001</span>
</code></pre></div>

<p><strong>一元|</strong>  <br />
当任意一个为1，就输出为1.  <strong>本文用来填补<code>0</code></strong>。
比如，把3补成8位二进制 <br />
<code>3 | 256</code> = <code>11 | 100000000</code> = <code>100000011</code></p>
<p><code>100000011.substring(1)</code>是不是就等于8位二进制呢<code>00000011</code></p>
<p>具备了这些基本知识，我们就开始先了解编码相关的知识。</p>
<h2 id="ascii-unicode-utf-8">ASCII码， Unicode , UTF-8</h2>
<h3 id="ascii">ASCII码</h3>
<p>ASCII码第一位始终是0, 那么实际可以表示的状态是 <code>2^7</code> = 128种状态。</p>
<p>ASCII 主要用于显示<strong>现代英文</strong>，到目前为止只定义了 <strong>128</strong> 个字符，包含控制字符和可显示字符。</p>
<ul>
<li>0~31 之间的<strong>ASCII码</strong>常用于控制像打印机一样的外围设备</li>
<li>32~127 之间的<strong>ASCII码</strong>表示的符号，<strong>在我们的键盘上都可以被找到</strong></li>
</ul>
<p>完整的 ASCII码对应表，可以参见 <strong><a href="https://www.asciim.cn/">基本ASCII码和扩展ASCII码</a></strong></p>
<p>接下来是Unicode和UTF-8编码，请先记住这个重要的知识：
-   Unicode: <strong>字符集</strong>
-   UTF-8: <strong>编码规则</strong></p>
<h3 id="unicode_1">Unicode</h3>
<p>Unicode 为世界上所有字符都分配了一个唯一的编号(<strong>码点</strong>)，这个编号范围从 0x000000 到 0x10FFFF (十六进制)，有 100 多万，每个字符都有一个唯一的 Unicode 编号，这个编号一般写成 16 进制，在前面加上 U+。例如：<code>掘</code>的 Unicode 是U+6398。</p>
<ul>
<li>U+0000到U+FFFF
最前面的65536个字符位，它的码点范围是从0一直到<strong>2<sup>16</sup>-1</strong>。所有最常见的字符都放在这里。</li>
<li>U+010000一直到U+10FFFF
剩下的字符都放着这里，码点范围从U+010000一直到U+10FFFF。</li>
</ul>
<p>Unicode有平面的概念，这里就不拓展了。</p>
<p><strong>Unicode只规定了每个字符的码点</strong>，到底用什么样的字节序表示这个码点，就涉及到编码方法。</p>
<h3 id="utf-8">UTF-8</h3>
<p>UTF-8 是互联网使用最多的一种 Unicode 的实现方式。还有 UTF-16（字符用两个字节或四个字节表示）和 UTF-32（字符用四个字节表示）等实现方式。</p>
<p>UTF-8 是它是一种变长的编码方式, 使用的字节个数从 <strong>1 到 4 个不等</strong>，最新的应该不止4个， 这个1-4不等，是后面编码和解码的关键。</p>
<p>UTF-8的编码规则：</p>
<ol>
<li>对于只有一个字节的符号，字节的第一位设为<code>0</code>，后面 7 位为这个符号的 Unicode 码。此时，对<strong>于英语字母UTF-8 编码和 ASCII 码是相同的。</strong></li>
<li>对于 <code>n</code> 字节的符号（<code>n &gt; 1</code>），第一个字节的前 <code>n</code> 位都设为 <code>1</code>，第 <code>n + 1</code> 位设为<code>0</code>，后面字节的前两位一律设为 <code>10</code>。剩下的没有提及的二进制位，全部为这个符号的 Unicode 码，如下表所示：</li>
</ol>
<table>
<thead>
<tr>
<th>Unicode 码点范围（十六进制）</th>
<th>十进制范围</th>
<th>UTF-8 编码方式（二进制）</th>
<th>字节数</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0000 0000 ~ 0000 007F</code></td>
<td><code>0 ~  127</code></td>
<td><code>0xxxxxxx</code></td>
<td>1</td>
</tr>
<tr>
<td><code>0000 0080 ~ 0000 07FF</code></td>
<td><code>128 ~ 2047</code></td>
<td><code>110xxxxx 10xxxxxx</code></td>
<td>2</td>
</tr>
<tr>
<td><code>0000 0800 ~ 0000 FFFF</code></td>
<td><code>2048 ~ 65535</code></td>
<td><code>1110xxxx 10xxxxxx 10xxxxxx</code></td>
<td>3</td>
</tr>
<tr>
<td><code>0001 0000 ~ 0010 FFFF</code></td>
<td><code>65536 ~ 1114111</code></td>
<td><code>11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</code></td>
<td>4</td>
</tr>
</tbody>
</table>
<p>我们可能没见过字节数为<code>2</code>或者为<code>4</code>的字符， 
字节数为<code>2</code>的可以去<a href="http://titus.uni-frankfurt.de/unicode/unitestx.htm">Unicode对应表</a>这里找，而等于<code>4</code>的可以去这看看<a href="https://www.unicode.org/charts/PDF/Unicode-13.0/">Unicode® 13.0 Versioned Charts Index</a>  </p>
<p>下面这些码点都处于<code>0000 0080 ~ 0000 07FF</code>, utf-8编码需要2个字节
<img alt="image.png" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7bba7b751658447c810cc09f5875639f~tplv-k3u1fbpfcp-watermark.image" /></p>
<p>下面这些码点都处于<code>0001 0000 ~ 0010 FFFF</code>, utf-8编码需要4个字节
<img alt="image.png" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5e5f540dc41c45e69c6a6697379def39~tplv-k3u1fbpfcp-watermark.image" /></p>
<p>可能这里光说不好理解，我们分别以英文字符<code>a</code>和中文字符<code>掘</code>来讲解一下：</p>
<p>为了验证结果，可以去 <a href="https://onlineutf8tools.com/convert-utf8-to-binary">Convert UTF8 to Binary Bits - Online UTF8 Tools</a></p>
<h4 id="a">英文字符<code>a</code></h4>
<ol>
<li>先获得其码点，<code>"a".charCodeAt(0)</code> 等于 <code>97</code></li>
<li>对照表格， 0~127, 需<code>1</code>个字节</li>
<li><code>97..toString(2)</code> 得到编码 <code>1100001</code></li>
<li>根据格式<code>0xxxxxxx</code>进行填充， 最终结果 </li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="mf">01100001</span>
</code></pre></div>

<h4 id="_18">中文字符<code>掘</code></h4>
<ol>
<li>先获得其码点，<code>"掘".charCodeAt(0)</code> 等于 <code>25496</code></li>
<li>对照表格，2048 ~ 65535 需<code>3</code>个字节</li>
<li><code>25496..toString(2)</code> 得到编码 <code>110 001110 011000</code></li>
<li>根绝格式<code>1110xxxx 10xxxxxx 10xxxxxx</code>进行填充, 最终结果如下</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="mf">11100110</span> <span class="mf">10001110</span> <span class="mf">10011000</span>
</code></pre></div>

<p><a href="https://onlineutf8tools.com/convert-utf8-to-binary">Convert UTF8 to Binary Bits - Online UTF8 Tools</a>执行结果： 完全匹配</p>
<p><img alt="image.png" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b687a1fb6cc4fba9261d69e7fea17bc~tplv-k3u1fbpfcp-watermark.image" /></p>
<h4 id="utf8">抽象把字符转为utf8格式二进制的方法</h4>
<p>基于上面的表格和转换过程，我们抽象一个方法，这个方法在<strong>之后的Base64编码和解码至关重要</strong>：</p>
<p>先看看功能，覆盖utf8编码1-3字节范围</p>
<div class="codehilite"><pre><span></span><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">to_binary</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">))</span>  <span class="c1">// 11100001</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">to_binary</span><span class="p">(</span><span class="s2">&quot;س&quot;</span><span class="p">))</span>  <span class="c1">// 1101100010110011</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">to_binary</span><span class="p">(</span><span class="s2">&quot;掘&quot;</span><span class="p">))</span> <span class="c1">// 111001101000111010011000</span>
</code></pre></div>

<p>方法如下</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">to_binary</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">string</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n/g</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">code</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//获取麻点</span>
    <span class="nx">code</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&lt;</span> <span class="mh">0x007F</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 1个字节</span>
      <span class="c1">// 0000 0000 ~ 0000 007F  0 ~ 127 1个字节</span>

      <span class="c1">// (code | 0b100000000).toString(2).slice(1)</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">code</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">2</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">8</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">code</span> <span class="o">&gt;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&lt;</span> <span class="mh">0x07FF</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 0000 0080 ~ 0000 07FF  128 ~ 2047 2个字节</span>
      <span class="c1">// 0x0080 的二进制为 10000000 ，8位，所以大于0x0080的，至少有8位</span>
      <span class="c1">// 格式 110xxxxx 10xxxxxx     </span>

      <span class="c1">// 高位 110xxxxx</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="p">((</span><span class="nx">code</span> <span class="o">&gt;&gt;</span> <span class="mf">6</span><span class="p">)</span> <span class="o">|</span> <span class="mb">0b11000000</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>
      <span class="c1">// 低位 10xxxxxx</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="p">((</span><span class="nx">code</span> <span class="o">&amp;</span> <span class="mb">0b111111</span><span class="p">)</span> <span class="o">|</span> <span class="mb">0b10000000</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&gt;</span> <span class="mh">0x0800</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span> <span class="o">&lt;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 0000 0800 ~ 0000 FFFF  2048 ~ 65535    3个字节</span>
      <span class="c1">// 0x0800的二进制为 1000 00000000，12位，所以大于0x0800的，至少有12位</span>
      <span class="c1">// 格式 1110xxxx 10xxxxxx 10xxxxxx</span>

      <span class="c1">// 最高位 1110xxxx</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="p">((</span><span class="nx">code</span> <span class="o">&gt;&gt;</span> <span class="mf">12</span><span class="p">)</span> <span class="o">|</span> <span class="mb">0b11100000</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>  
      <span class="c1">// 第二位 10xxxxxx</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="p">(((</span><span class="nx">code</span> <span class="o">&gt;&gt;</span> <span class="mf">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mb">0b111111</span><span class="p">)</span> <span class="o">|</span> <span class="mb">0b10000000</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>
      <span class="c1">// 第三位 10xxxxxx</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="p">((</span><span class="nx">code</span> <span class="o">&amp;</span> <span class="mb">0b111111</span><span class="p">)</span> <span class="o">|</span> <span class="mb">0b10000000</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 0001 0000 ~ 0010 FFFF   65536 ~ 1114111   4个字节 </span>
      <span class="c1">// https://www.unicode.org/charts/PDF/Unicode-13.0/U130-2F800.pdf</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&quot;暂不支持码点大于65535的字符&quot;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>方法中有三个地方稍微难理解一点，我们一起来解读一下：</p>
<ol>
<li><strong>二字节 <code>(code &gt;&gt; 6) | 0b11000000</code></strong>
  其作用是生成高位二进制。 <br />
  我们以实际的一个栗子来讲解，以<code>س</code>为例，其码点为<code>0x633</code>,在<code>0000 0080 ~ 0000 07FF</code>之间，占两个字节， 在其二进制编码为<code>11 000110011</code> ， 其填充格式如下， 低位要用<strong>6位</strong>。 <br />
<code>js
 110xxxxx 10xxxxxx</code>
 为了方便观察，我们把 <code>11 000110011</code> 重新调整一下 <code>11000 110011</code>。     </li>
</ol>
<p><strong>(code &gt;&gt; 6) 等于 00110011 &gt;&gt; 6，右移6位， 直接干掉低6位</strong>。
 为什么是6呢，因为低位需要6位，右移动6位后，剩下的就是用于高位操作的位了。
 ```js
 11000000
    11000 | 110011 </p>
<hr />
<p>11011000    <br />
 ```</p>
<ol>
<li><strong>二字节 <code>(code &amp; 0b111111) | 0b10000000</code></strong> <br />
   作用，用于生成低位二进制。以<code>س</code>为例，<code>11000 110011</code>, 填充格式</li>
</ol>
<p><code>js
   110xxxxx 10xxxxxx</code>
 <code>(code &amp; 0b111111)这步的操作是为了干掉6位以上的高位，仅仅保留低6位</code>。 一元<code>&amp;</code>符号，两边都是1的时候才会是1，妙啊。</p>
<p>```js
 11000 110011
       111111</p>
<hr />
<div class="codehilite"><pre><span></span><code>   110011
</code></pre></div>

<p><code>``
 接着进行</code>| 0b10000000<code>, 主要是按照格式</code>10xxxxxx`进行位数填补, 让其满8位。 </p>
<div class="codehilite"><pre><span></span><code> <span class="mf">11000</span> <span class="mf">110011</span>
       <span class="mf">111111</span>         <span class="p">(</span><span class="nx">code</span> <span class="o">&amp;</span> <span class="mb">0b111111</span><span class="p">)</span>
 <span class="o">------------------</span>
       <span class="mf">110011</span>  
    <span class="mf">10</span> <span class="mo">000000</span>         <span class="p">(</span><span class="nx">code</span> <span class="o">&amp;</span> <span class="mb">0b111111</span><span class="p">)</span> <span class="o">|</span> <span class="mb">0b10000000</span>
<span class="o">-------------------</span>
    <span class="mf">10</span> <span class="mf">110011</span>
</code></pre></div>

<h2 id="base64_3">Base64编码和解码</h2>
<h3 id="utf-8base64">utf-8转Base64编码规则</h3>
<ol>
<li>获取每个字符的Unicode码，转为utf-8编码   </li>
<li><strong>三个字节</strong>作为一组，一共是24个二进制位 <br />
    字节数不能被 3 整除，用0字节值在末尾补足</li>
<li>按照<strong>6个比特位</strong>一组分组，前两位补0，凑齐8位</li>
<li>计算每个分组的数值</li>
<li>以第<code>4</code>步的值作为索引，去ASCII码表找对应的值</li>
<li>替换第<code>2</code>步<strong>添加字节数个数</strong>的 <code>=</code><br />
    比如第<code>2</code>添加了2个字节，后面是2个<code>=</code></li>
</ol>
<p>以大<code>掘A</code>为例, 我们通过上面的<code>utf8_to_binary</code>方法得到utf8的编码 <br />
<code>11100110 10001110 10011000 11000001</code>, 其字节数不能被3整除，后面填补</p>
<div class="codehilite"><pre><span></span><code><span class="mf">11100110</span>
<span class="mf">10001110</span>
<span class="mf">10011000</span>
<span class="mf">01000001</span>
<span class="o">--------</span>
<span class="mf">00000000</span>
<span class="mf">00000000</span>
</code></pre></div>

<p>6位一组分为四组， 高位补<code>0</code>, 用<code>|</code> 分割一下填补的。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">00</span> <span class="err">|</span> <span class="mf">111001</span>  <span class="o">=&gt;</span> <span class="mf">57</span> <span class="o">=&gt;</span> <span class="mf">5</span>
<span class="mf">00</span> <span class="err">|</span> <span class="mf">101000</span>  <span class="o">=&gt;</span> <span class="mf">40</span> <span class="o">=&gt;</span> <span class="n">o</span>
<span class="mf">00</span> <span class="err">|</span> <span class="mf">111010</span>  <span class="o">=&gt;</span> <span class="mf">58</span> <span class="o">=&gt;</span> <span class="mf">6</span>
<span class="mf">00</span> <span class="err">|</span> <span class="mf">011000</span>  <span class="o">=&gt;</span> <span class="mf">24</span> <span class="o">=&gt;</span> <span class="n">Y</span>

<span class="mf">00</span> <span class="err">|</span> <span class="mf">110000</span>  <span class="o">=&gt;</span> <span class="mf">16</span> <span class="o">=&gt;</span> <span class="n">Q</span>
<span class="mf">00</span> <span class="err">|</span> <span class="mf">010000</span>  <span class="o">=&gt;</span> <span class="mf">16</span> <span class="o">=&gt;</span> <span class="n">Q</span>
<span class="mf">00</span> <span class="err">|</span> <span class="mf">000000</span>  <span class="o">=&gt;</span>    <span class="o">=&gt;</span> <span class="o">=</span>
<span class="mf">00</span> <span class="err">|</span> <span class="mf">000000</span>  <span class="o">=&gt;</span>    <span class="o">=&gt;</span> <span class="o">=</span>
</code></pre></div>

<p>结果是：<code>5o6YQQ==</code>， 完美。</p>
<h3 id="utf-8base64_1">utf-8转Base64编码规则代码实现</h3>
<p>基于上面的<code>to_binary</code>方法和base64的转换规则，就很简单啦：  <br />
先看看执行效果，very good, 和 <strong><a href="https://base64.us/">base64.us</a></strong> 结果完全一致。</p>
<div class="codehilite"><pre><span></span><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">utf8_to_base64</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">));</span> <span class="c1">// YQ==</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">utf8_to_base64</span><span class="p">(</span><span class="s2">&quot;Ȃ&quot;</span><span class="p">));</span>  <span class="c1">// yII=</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">utf8_to_base64</span><span class="p">(</span><span class="s2">&quot;中国人&quot;</span><span class="p">));</span> <span class="c1">// 5Lit5Zu95Lq6</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">utf8_to_base64</span><span class="p">(</span><span class="s2">&quot;Coding Writing 好文召集令｜后端、大前端双赛道投稿，2万元奖池等你挑战！&quot;</span><span class="p">));</span>
<span class="c1">//Q29kaW5nIFdyaXRpbmcg5aW95paH5Y+s6ZuG5Luk772c5ZCO56uv44CB5aSn5YmN56uv5Y+M6LWb6YGT5oqV56i/77yMMuS4h+WFg+WlluaxoOetieS9oOaMkeaImO+8gQ==</span>
</code></pre></div>

<p>完整代码如下：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">BASE64_CHARTS</span> <span class="o">=</span> <span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#39;</span>
<span class="kd">function</span> <span class="nx">utf8_to_base64</span><span class="p">(</span><span class="nx">str</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">binaryStr</span> <span class="o">=</span> <span class="nx">to_binary</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">binaryStr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="c1">// 需要填补的=的数量</span>
  <span class="kd">let</span> <span class="nx">paddingCharLen</span> <span class="o">=</span> <span class="nx">len</span> <span class="o">%</span> <span class="mf">24</span> <span class="o">!==</span> <span class="mf">0</span> <span class="o">?</span> <span class="p">(</span><span class="mf">24</span> <span class="o">-</span> <span class="nx">len</span> <span class="o">%</span> <span class="mf">24</span><span class="p">)</span> <span class="o">/</span> <span class="nx">8</span> : <span class="kt">0</span><span class="p">;</span>

  <span class="c1">//6个一组</span>
  <span class="kd">const</span> <span class="nx">groups</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">binaryStr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mf">6</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">binaryStr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mf">6</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mf">6</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">g</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">padEnd</span><span class="p">(</span><span class="mf">6</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">groups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// 求值</span>
  <span class="kd">let</span> <span class="nx">base64Str</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">b64str</span><span class="p">,</span> <span class="nx">cur</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">b64str</span> <span class="o">+=</span> <span class="nx">BASE64_CHARTS</span><span class="p">[</span><span class="o">+</span><span class="sb">`0b</span><span class="si">${</span><span class="nx">cur</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">b64str</span>
  <span class="p">},</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

  <span class="c1">// 填充=</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">paddingCharLen</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">base64Str</span> <span class="o">+=</span> <span class="nx">paddingCharLen</span> <span class="o">&gt;</span> <span class="mf">1</span> <span class="o">?</span> <span class="s2">&quot;==&quot;</span> <span class="o">:</span> <span class="s2">&quot;=&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">base64Str</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>至于解码，是其逆过程，留给大家去实现吧。</p>
<h2 id="_19">其他的成熟方案</h2>
<ol>
<li>当然是基于已有的 <code>btoa</code>和<code>atob</code>, 
但是 unescape是不被推荐使用的方法</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">utf8_to_b64</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">btoa</span><span class="p">(</span><span class="nx">unescape</span><span class="p">(</span><span class="nb">encodeURIComponent</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">b64_to_utf8</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">atob</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)));</span>
<span class="p">}</span>
</code></pre></div>

<p>// Usage:
utf8_to_b64('✓ à la mode'); // "4pyTIMOgIGxhIG1vZGU="
b64_to_utf8('4pyTIMOgIGxhIG1vZGU='); // "✓ à la mode"</p>
<ol>
<li>
<p>MDN的 <a href="https://developer.mozilla.org/en-US/docs/Glossary/Base64#solution_2_%E2%80%93_rewriting_atob_and_btoa_using_typedarrays_and_utf-8" title="Permalink to Solution #2 – rewriting atob() and btoa() using TypedArrays and UTF-8">rewriting <code>atob()</code> and <code>btoa()</code> using <code>TypedArray</code>s and UTF-8</a>
其支持到6字节，但是可读性并不好。</p>
</li>
<li>
<p>第三方库 <a href="https://www.npmjs.com/package/base64-js">base64-js</a> 与 <a href="https://www.npmjs.com/package/js-base64">js-base64</a>都是周下载量过百万的库。</p>
</li>
</ol>
<p>虽然有那么多成熟的，但是我们理解和自己实现，才能更明白Base64的编码原理。</p>
<h2 id="_20">额外补充一点</h2>
<ol>
<li>编码关系图
借用[<a href="https://www.cnblogs.com/reycg-blog/p/10021658.html">你真的了解 Unicode 和 UTF-8 吗？</a>]一张图：</li>
</ol>
<p><img alt="image.png" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68d76d951cff42db802cb7a5514e5118~tplv-k3u1fbpfcp-watermark.image" /></p>
<ol>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMString">DOMString</a> 是<code>utf-16</code>编码</li>
</ol>
<h2 id="_21">写在最后</h2>
<p>写作不易，你的三连（一赞，一评，一收藏），就是我最大的动力。</p>
<p>点赞<strong>过百</strong>，再写篇浏览器，DOM, JS等关于编码的文章。</p>
<h2 id="_22">引用</h2>
<blockquote>
<p><a href="https://www.unicode.org/charts/About.html">Version-Specific Charts</a>  <br />
<a href="https://www.unicode.org/versions/Unicode13.0.0">Unicode13.0.0</a> <br />
<a href="https://www.unicode.org/charts/PDF/Unicode-13.0/">Unicode® 13.0 Versioned Charts Index</a>    <br />
<a href="https://datatracker.ietf.org/doc/html/rfc4648">RFC 4648  | The Base16, Base32, and Base64 Data Encodings</a>  <br />
<a href="https://developer.mozilla.org/en-US/docs/Glossary/Base64">Base64 encoding and decoding</a> <br />
<a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html?20110621174302">字符编码笔记：ASCII，Unicode 和 UTF-8</a>  <br />
<a href="http://www.ruanyifeng.com/blog/2014/12/unicode.html">Unicode与JavaScript详解</a> <br />
<a href="https://juejin.cn/post/6898104998547161096">Base64 编码入门教程</a>
<a href="https://juejin.cn/post/6844903698045370376">Base64原理</a> <br />
<a href="https://juejin.cn/post/6946169611461066789">详解base64原理</a> <br />
<a href="https://juejin.cn/post/6844904197519835150">一文读懂base64编码</a> <br />
<a href="https://juejin.cn/post/6844903838286102536">JS 中关于 base64 的一些事</a> <br />
<a href="https://juejin.cn/post/6844903663459106829">Base64 的原理、实现及应用</a> <br />
<a href="https://juejin.cn/post/6913814643618086925">图片与Base64换算关系</a><br />
[<a href="https://www.cnblogs.com/reycg-blog/p/10021658.html">你真的了解 Unicode 和 UTF-8 吗？</a>] <br />
<a href="https://juejin.cn/post/6844903590155272199">Unicode中UTF-8与UTF-16编码详解</a> <br />
<a href="http://titus.uni-frankfurt.de/unicode/unitestx.htm">Unicode对应表</a> <br />
<a href="https://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html">JavaScript Source Map 详解</a></p>
</blockquote><h1>【干货】私藏的这些高级工具函数，你拥有几个?</h1><p>本文已参与好文召集令活动，点击查看：<a href="https://juejin.cn/post/6978685539985653767">后端、大前端双赛道投稿，2万元奖池等你挑战！</a></p>
<h2 id="_1">前言</h2>
<p>很多功能，其实内置的Web API已支持，<br />
<em> 比如基于<code>URLSearchParams</code>或者<code>URL</code>的queryString获取和生成 <br />
</em> 比如基于<code>btoa,atob</code>的base64的编码和解码 <br />
<em> 比如基于<code>sendBeacon</code>的数据上报 <br />
</em> 比如基于 <code>Array.from</code>的序列生成
* 比如基于<code>canvas</code>的视频截图
* 比如基于<code>URL</code>的UUID生成</p>
<p>我们用精简的代码来实现相对复杂的功能，没有第三方库，你也能秀得飞起。</p>
<p>本文收录在 <strong><a href="https://juejin.cn/column/6979380367216082957">基础进阶</a></strong> 专栏，欢迎关注和收藏, 往期经典：
* <a href="https://juejin.cn/post/6978744007601946654">三千文字，也没写好 Function.prototype.call</a> 200+ star
* <a href="https://juejin.cn/post/6977239278145241101">那些你熟悉而又陌生的函数</a> 200 star  <br />
* <a href="https://juejin.cn/post/6982742095375597575">这16种原生函数和属性的区别，你真的知道吗？ 精心收集，高级前端必备知识，快快打包带走</a> 96 star</p>
<p>目录(方便移动端阅读)
* localStorage的已使用空间
* 带图带事件的<strong>桌面通知</strong>
* 原生30行代码实现视频截图
* 基于<code>URLSearchParams</code>获取queryString的值
* 基于<code>atob</code>和<code>btoa</code>的base64编码和解码
* <strong>非正则替换</strong>html代码encode和decode
* 相对地址转换为绝对地址
* 基于<code>URL</code>或者<code>Crypto.getRandomValues</code>生成UUID
* 基于<code>Array.from</code>的序列生成器
* 基于<code>sendBeacon</code>的安全的数据上报
* 基于<code>toLocaleString</code>千分位
* Promise顺序执行
* 延时执行delay
* 进度值映射
* 滑滚动页面到顶部
* 禁止选择和复制
* 禁止图片拖拽
* 自增长ID</p>
<h2 id="localstorage">localStorage的已使用空间</h2>
<p>在较新的chrome上测试，localStorage的存储是<strong>按照字符个数来算的。 包含键和值的</strong>。 <br />
所以在测试代码中，你把<code>a</code>修改<code>啊</code>，不会影响存储的数量。 <strong>但是键的长度，会影响存储的数量。</strong></p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">getLSUsedSpace</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">).</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">total</span><span class="p">,</span> <span class="nx">curKey</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">curKey</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">total</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">total</span> <span class="o">+=</span> <span class="nx">localStorage</span><span class="p">[</span><span class="nx">curKey</span><span class="p">].</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">curKey</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">total</span><span class="p">;</span>
    <span class="p">},</span> <span class="mf">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">localStorage</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
<span class="nx">localStorage</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;啊&quot;</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getLSUsedSpace</span><span class="p">());</span> <span class="c1">// 2</span>
</code></pre></div>

<p><strong>溢出测试</strong>：</p>
<p><code>key</code>的值为长度为10的 <code>kkkkkkkkkk</code>: <br />
输出结果： Max: 5242880  value Length: 5242870 <br />
当你把<code>key</code>修改长度为1的<code>k</code>: <br />
输出结果：Max: 5242880  value Length: 5242879</p>
<div class="codehilite"><pre><span></span><code><span class="nx">localStorage</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
<span class="kd">let</span> <span class="nx">valLength</span> <span class="o">=</span> <span class="mf">0</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">({</span> <span class="nx">length</span><span class="o">:</span> <span class="mf">5242800</span> <span class="p">},</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="s2">&quot;啊&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="nx">valLength</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mf">10000000000000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;a&quot;</span>
        <span class="nx">valLength</span> <span class="o">+=</span> <span class="mf">1</span><span class="p">;</span>
        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="sb">`kkkkkkkkkk`</span><span class="p">,</span> <span class="nx">str</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;存储失败&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Max:&quot;</span><span class="p">,</span> <span class="nx">getLSUsedSpace</span><span class="p">(),</span> <span class="s2">&quot; value Length:&quot;</span><span class="p">,</span> <span class="nx">valLength</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e32531e2b4340fda3293f44536f8e99~tplv-k3u1fbpfcp-watermark.image" /></p>
<p><strong>注意</strong></p>
<ol>
<li>超过存储上线是会报错的：</li>
</ol>
<p><img alt="image.png" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9825e41c39b940579a37f9fe61d708bd~tplv-k3u1fbpfcp-watermark.image" /></p>
<ol>
<li>如何捕获错误,可以参考 MDN <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API#testing_for_availability">testing_for_availability</a></li>
</ol>
<p>大致是对Error的错误码和name进行判断</p>
<div class="codehilite"><pre><span></span><code><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">DOMException</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
            <span class="c1">// everything except Firefox</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mf">22</span> <span class="o">||</span>
            <span class="c1">// Firefox</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mf">1014</span> <span class="o">||</span>
            <span class="c1">// test name field too, because code might not be present</span>
            <span class="c1">// everything except Firefox</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;QuotaExceededError&#39;</span> <span class="o">||</span>
            <span class="c1">// Firefox</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;NS_ERROR_DOM_QUOTA_REACHED&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="c1">// acknowledge QuotaExceededError only if there&#39;s something already stored</span>
            <span class="p">(</span><span class="nx">storage</span> <span class="o">&amp;&amp;</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span><span class="p">);</span>
</code></pre></div>

<p><strong>参考引用</strong>  <br />
<a href="https://stackoverflow.com/questions/3027142/calculating-usage-of-localstorage-space">calculating-usage-of-localstorage-space</a> <br />
<a href="https://stackoverflow.com/questions/2989284/what-is-the-max-size-of-localstorage-values/25812530#25812530">what-is-the-max-size-of-localstorage-values</a>   <br />
<a href="https://arty.name/localstorage.html">Test of localStorage limits/quota</a></p>
<h2 id="_2">带图带事件的<strong>桌面通知</strong></h2>
<p>网页也可以以桌面弹框的形式进行通知，先看个效果图：  <br />
有头像，有标题，有文本，<strong>点击消息通知还能让窗体聚焦</strong>，真帅。</p>
<p><img alt="image.png" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cac0c6b24ecc4438b9b4d6db4f05fd23~tplv-k3u1fbpfcp-watermark.image" /></p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">doNotify</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Notification</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">event</span> <span class="k">in</span> <span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">notification</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">notify</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s2">&quot;Notification&quot;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;This browser does not support desktop notification&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">===</span> <span class="s2">&quot;granted&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">doNotify</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">events</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">!==</span> <span class="s2">&quot;denied&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Notification</span><span class="p">.</span><span class="nx">requestPermission</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">permission</span><span class="p">)</span> <span class="p">{</span>           
            <span class="k">if</span> <span class="p">(</span><span class="nx">permission</span> <span class="o">===</span> <span class="s2">&quot;granted&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">doNotify</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">events</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong> <br />
tag还可以用去重消息。</p>
<div class="codehilite"><pre><span></span><code>     <span class="nx">notify</span><span class="p">(</span><span class="s2">&quot;中奖提示&quot;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">icon</span><span class="o">:</span> <span class="s2">&quot;https://sf1-ttcdn-tos.pstatp.com/img/user-avatar/f1a9f122e925aeef5e4534ff7f706729~300x300.image&quot;</span><span class="p">,</span>
            <span class="nx">body</span><span class="o">:</span> <span class="s2">&quot;恭喜你，掘金签到一等奖&quot;</span><span class="p">,</span>
            <span class="nx">tag</span><span class="o">:</span> <span class="s2">&quot;prize&quot;</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="nx">onclick</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">);</span>
                <span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">})</span>
</code></pre></div>

<p><strong>参考引用</strong><br />
<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/notification">notification</a> <br />
<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Notifications_API/Using_the_Notifications_API">使用 Web Notifications</a>   </p>
<h2 id="30">原生30行代码实现视频截图</h2>
<p>基本原理就是把视频画到Canvas里面，然后调用<code>toDataURL</code>或者<code>toBlob</code>，再利用a标签模拟点击，download属性指定名字。</p>
<p>看一下效果：</p>
<p><img alt="image.png" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52f0f434712042fe86f89a3cd69f4977~tplv-k3u1fbpfcp-watermark.image" />
<strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code>     <span class="kd">function</span> <span class="nx">captureVideo</span><span class="p">(</span><span class="nx">videoEl</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">canvasEl</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">dataUrl</span><span class="p">;</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">cps</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">videoEl</span><span class="p">);</span>
                <span class="kd">const</span> <span class="nx">width</span> <span class="o">=</span> <span class="o">+</span><span class="nx">cps</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;px&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
                <span class="kd">const</span> <span class="nx">height</span> <span class="o">=</span> <span class="o">+</span><span class="nx">cps</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;px&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

                <span class="nx">canvasEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;canvas&quot;</span><span class="p">);</span>
                <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="sb">`position:fixed;left:-9999px`</span><span class="p">;</span>
                <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
                <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>

                <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">canvasEl</span><span class="p">);</span>

                <span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
                <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">videoEl</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
                <span class="c1">// const image = canvas.toDataURL(&quot;image/png&quot;);</span>
                <span class="nx">dataUrl</span> <span class="o">=</span> <span class="nx">canvasEl</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">();</span>

                <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">canvasEl</span><span class="p">);</span>
                <span class="nx">canvasEl</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">dataUrl</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">canvasEl</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">canvasEl</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">dataUrl</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">dataUrl</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong> <br />
 注意添加<code>crossorigin="anonymous"</code>，不然转为图片会失败。</p>
<div class="codehilite"><pre><span></span><code>  <span class="o">&lt;</span><span class="nx">video</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;videoEL&quot;</span> <span class="nx">controls</span> <span class="nx">autoplay</span> <span class="nx">crossorigin</span><span class="o">=</span><span class="s2">&quot;anonymous&quot;</span>
        <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;https://api.dogecloud.com/player/get.mp4?vcode=5ac682e6f8231991&amp;userId=17&amp;ext=.mp4&quot;</span> <span class="nx">width</span><span class="o">=</span><span class="s2">&quot;500&quot;</span><span class="o">&gt;&lt;</span><span class="err">/video&gt;</span>

<span class="kd">function</span> <span class="nx">download</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">aEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>
    <span class="nx">aEl</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="nx">aEl</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="s2">&quot;视频.png&quot;</span><span class="p">;</span>
    <span class="nx">aEl</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">doCaptureVideo</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">captureVideo</span><span class="p">(</span><span class="nx">videoEL</span><span class="p">);</span>
    <span class="nx">download</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">doCaptureVideo</span><span class="p">()</span>
</code></pre></div>

<h2 id="urlsearchparamsurlquerystring">基于<code>URLSearchParams</code>或<code>URL</code>获取queryString的值</h2>
<p>常用的方式是使用正则或者<code>split</code>方法，其实不然，<code>URLSearchParams</code>和<code>URL</code>都能很好的实现功能。  </p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">urlSP</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">getQueryString</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">urlSP</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">urlObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">getQueryString</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">测试地址</span><span class="err">：</span> <span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span><span class="nx">pid</span><span class="o">=</span><span class="mf">10</span>

<span class="kd">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">;</span>
<span class="nx">getQueryString</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="nx">getQueryString</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">));</span>  <span class="c1">// pid 10</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&quot;cid&quot;</span><span class="p">,</span> <span class="nx">getQueryString</span><span class="p">(</span><span class="s2">&quot;cid&quot;</span><span class="p">));</span>  <span class="c1">// cid null</span>
</code></pre></div>

<p><strong>参考引用</strong> <br />
MDN文献：<a href="https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams">URLSearchParams-MDN</a> <br />
CanIUse兼容性: <a href="https://caniuse.com/?search=URLSearchParams">URLSearchParams: 95.63%</a> <br />
Polyfill: <a href="https://github.com/jerrybendy/url-search-params-polyfill">url-search-params-polyfill</a></p>
<h2 id="atobbtoabase64">基于<code>atob</code>和<code>btoa</code>的base64编码和解码</h2>
<p>浏览器内置了base64编码和解码的能力，第三方库，不需要的。    </p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">utf8_to_b64</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">btoa</span><span class="p">(</span><span class="nx">unescape</span><span class="p">(</span><span class="nb">encodeURIComponent</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">b64_to_utf8</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">atob</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)));</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">utf8_to_b64</span><span class="p">(</span><span class="s1">&#39;✓ à la mode&#39;</span><span class="p">);</span> <span class="c1">// &quot;4pyTIMOgIGxhIG1vZGU=&quot;</span>
<span class="nx">b64_to_utf8</span><span class="p">(</span><span class="s1">&#39;4pyTIMOgIGxhIG1vZGU=&#39;</span><span class="p">);</span> <span class="c1">// &quot;✓ à la mode&quot;</span>
</code></pre></div>

<p><strong>参考引用</strong>    <br />
MDN文献：<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/atob">atob</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/btoa">btoa</a> <br />
CanIUse兼容性: <a href="https://caniuse.com/?search=btoa">btoa 99.68%</a> <br />
Polyfill: <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WindowOrWorkerGlobalScope/btoa#polyfill" title="Permalink to Polyfill">MDN Polyfill</a><br />
<a href="https://developer.mozilla.org/en-US/docs/Glossary/Base64">Base64</a></p>
<h2 id="htmlencodedecode"><strong>非正则替换</strong>的html代码encode和decode</h2>
<p>常规的方式是使用正则替换，这里是另外一种思路。</p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">htmlencode</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">s</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="nx">div</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">htmldecode</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">div</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">||</span> <span class="nx">div</span><span class="p">.</span><span class="nx">textContent</span><span class="p">;</span>
    <span class="nx">div</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code>htmlencode(&quot;<span class="nt">&lt;div&gt;</span>3&gt;5 <span class="err">&amp;</span> 666<span class="nt">&lt;/div&gt;</span>&quot;); // <span class="ni">&amp;lt;</span>div<span class="ni">&amp;gt;</span>3<span class="ni">&amp;gt;</span>5 <span class="ni">&amp;amp;</span> 666<span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>
htmldecode(&quot;<span class="ni">&amp;lt;</span>div<span class="ni">&amp;gt;</span>3<span class="ni">&amp;gt;</span>5 <span class="ni">&amp;amp;</span> 666<span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>&quot;) // <span class="nt">&lt;div&gt;</span>3&gt;5 <span class="err">&amp;</span> 666<span class="nt">&lt;/div&gt;</span>
</code></pre></div>

<h2 id="_3">相对地址转换为绝对地址</h2>
<p>基于当前页面的相对地址转换为绝对地址。    </p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">realativeToAbs</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">aEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>
    <span class="nx">aEl</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">href</span><span class="p">;</span>    

    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">aEl</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
    <span class="nx">aEl</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;realativeToAbs&quot;</span><span class="p">,</span> <span class="nx">realativeToAbs</span><span class="p">(</span><span class="s2">&quot;../a/b/b/index.html&quot;</span><span class="p">));</span>
<span class="c1">// realativeToAbs http://127.0.0.1:5500/a/b/b/index.html</span>
</code></pre></div>

<h2 id="urlcryptogetrandomvaluesuuid">基于<code>URL</code>或者<code>Crypto.getRandomValues</code>生成UUID</h2>
<p>基于<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL">URL.createObjectURL</a>或者<a href="https://developer.mozilla.org/en-US/docs/Web/API/Crypto/getRandomValues">Crypto.getRandomValues</a></p>
<p>URL.createObjectURL 产生的地址为 <code>blob:https://developer.mozilla.org/cb48b940-c625-400a-a393-176c3635020b</code>, 其后部分就是一个UUID</p>
<p><strong>代码</strong> <br />
方式一： </p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">genUUID</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="k">new</span> <span class="nx">Blob</span><span class="p">([]));</span>
    <span class="c1">// const uuid = url.split(&quot;/&quot;).pop();</span>
    <span class="kd">const</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span> <span class="mf">1</span><span class="p">);</span>
    <span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">uuid</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">genUUID</span><span class="p">()</span> <span class="c1">// cd205467-0120-47b0-9444-894736d873c7</span>
</code></pre></div>

<p>方式二：  </p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">uuidv4</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">([</span><span class="mf">1e7</span><span class="p">]</span><span class="o">+-</span><span class="mf">1e3</span><span class="o">+-</span><span class="mf">4e3</span><span class="o">+-</span><span class="mf">8e3</span><span class="o">+-</span><span class="mf">1e11</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[018]/g</span><span class="p">,</span> <span class="nx">c</span> <span class="p">=&gt;</span>
    <span class="p">(</span><span class="nx">c</span> <span class="o">^</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">getRandomValues</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mf">1</span><span class="p">))[</span><span class="mf">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mf">15</span> <span class="o">&gt;&gt;</span> <span class="nx">c</span> <span class="o">/</span> <span class="mf">4</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">uuidv4</span><span class="p">()</span> <span class="c1">// 38aa1602-ba78-4368-9235-d8703cdb6037</span>
</code></pre></div>

<p><strong>参考引用</strong> <br />
<a href="https://medium.com/teads-engineering/generating-uuids-at-scale-on-the-web-2877f529d2a2">generating-uuids-at-scale-on-the-web-2877f529d2a2</a>    <br />
<a href="https://stackoverflow.com/questions/6906916/collisions-when-generating-uuids-in-javascript">collisions-when-generating-uuids-in-javascript</a></p>
<h2 id="arrayfrom">基于<code>Array.from</code>的序列生成器</h2>
<p>造有序数据，无序数据，等等。</p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">range</span> <span class="o">=</span> <span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">stop</span><span class="p">,</span> <span class="nx">step</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span>
    <span class="p">{</span> <span class="nx">length</span><span class="o">:</span> <span class="p">(</span><span class="nx">stop</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="nx">step</span> <span class="o">+</span> <span class="mf">1</span><span class="p">},</span> 
    <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">start</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">step</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">range</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">4</span><span class="p">,</span> <span class="mf">1</span><span class="p">);</span> <span class="c1">// [0, 1, 2, 3, 4]</span>
<span class="nx">range</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">9</span><span class="p">,</span> <span class="mf">3</span><span class="p">);</span> <span class="c1">// [0, 3, 6, 9]</span>
<span class="nx">range</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">8</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span> <span class="c1">// [0, 2.5, 5, 7.5]</span>
</code></pre></div>

<h2 id="sendbeacon">基于<code>sendBeacon</code>的安全的数据上报</h2>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon">sendBeacon</a> 异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">report</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">sendBeacon</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;sendBeacon不被支持&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">navigator</span><span class="p">.</span><span class="nx">sendBeacon</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong>  </p>
<div class="codehilite"><pre><span></span><code><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;unload&#39;</span><span class="p">,</span> <span class="nx">logData</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">logData</span><span class="p">()</span> <span class="p">{</span>
   <span class="nx">report</span><span class="p">(</span><span class="s2">&quot;/log&quot;</span><span class="p">,</span> <span class="s2">&quot;被卸载了&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="tolocalestring">基于<code>toLocaleString</code>千分位</h2>
<p>正则？ 遍历？ 不需要的。内置函数就解决。    <br />
当然，如果是超大的数，可能是会有问题的。</p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nv">function</span> <span class="nv">formatMoney</span><span class="ss">(</span><span class="nv">num</span><span class="ss">)</span>{
    <span class="k">return</span> <span class="ss">(</span><span class="o">+</span><span class="nv">num</span><span class="ss">)</span>.<span class="nv">toLocaleString</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">en-US</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">;</span>
}
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code>console.log(formatMoney(123456789));  // 123,456,789
console.log(formatMoney(6781)) // 6,781
console.log(formatMoney(5)) // 5

超大的数
formatMoney(19999999933333333333333) // 19,999,999,933,333,333,000,000
</code></pre></div>

<h2 id="promise">Promise顺序执行</h2>
<p>让Promise顺序的执行，并支持初始化参数和结果作为参数传递。   </p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">runPromises</span><span class="p">(</span><span class="nx">promiseCreators</span><span class="p">,</span> <span class="nx">initData</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">promiseCreators</span>
        <span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">promise</span>
                <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
            <span class="p">,</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">initData</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">promise1</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span> <span class="o">=</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span> <span class="o">+</span> <span class="mf">1000</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">promise2</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span> <span class="o">-</span><span class="mf">500</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">runPromises</span><span class="p">([</span><span class="nx">promise1</span><span class="p">,</span> <span class="nx">promise2</span><span class="p">],</span> <span class="mf">1</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="p">=&gt;</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">));</span>
</code></pre></div>

<h2 id="delay">延时执行delay</h2>
<p>延时执行某函数，且只会执行一次。</p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">delay</span><span class="p">(</span><span class="nx">fn</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">},</span> <span class="nx">delay</span> <span class="o">=</span> <span class="mf">5000</span><span class="p">,</span> <span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">ticket</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">runned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">run</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">runned</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">runned</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">ticket</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
                        <span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">},</span> <span class="nx">delay</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">},</span>
        <span class="nx">cancel</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">ticket</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">delay</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;你们好&quot;</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">run</span><span class="p">();</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">run</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">delay</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;你好：&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">run</span><span class="p">(</span><span class="s2">&quot;吉他&quot;</span><span class="p">);</span>
<span class="nx">run</span><span class="p">(</span><span class="s2">&quot;吉他&quot;</span><span class="p">);</span>

<span class="c1">// 你们好</span>
<span class="c1">// 你好： 吉他</span>
</code></pre></div>

<h2 id="_4">进度值映射</h2>
<p>进度映射，比较只有 10%的进度，确要显示50%的进度的场景。</p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">adjustProgress</span><span class="p">(</span><span class="nx">progress</span>: <span class="kt">number</span><span class="p">,</span> <span class="nx">mapping</span><span class="o">:</span> <span class="p">{</span> <span class="nx">real</span>: <span class="kt">number</span><span class="p">;</span> <span class="nx">target</span>: <span class="kt">number</span> <span class="p">}[]</span> <span class="o">=</span> <span class="p">[])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">progress</span> <span class="o">&lt;</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mf">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mapping</span> <span class="o">||</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">progress</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 第一个</span>
    <span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">progress</span> <span class="o">&lt;=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">real</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">progress</span> <span class="o">*</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">target</span> <span class="o">/</span> <span class="nx">f</span><span class="p">.</span><span class="nx">real</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 最后一个</span>
    <span class="kd">const</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">[</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mf">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">progress</span> <span class="o">&gt;=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">curIndex</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">m</span> <span class="o">=&gt;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">real</span> <span class="o">&gt;=</span> <span class="nx">progress</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">curIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">progress</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">[</span><span class="nx">curIndex</span><span class="p">];</span>
    <span class="kd">const</span> <span class="nx">pre</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">[</span><span class="nx">curIndex</span> <span class="o">-</span> <span class="mf">1</span><span class="p">];</span>
    <span class="c1">//     原基数     +   实际进度/最大实际进度 * 期望间距</span>
    <span class="k">return</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">target</span> <span class="o">+</span> <span class="p">(</span><span class="nx">progress</span> <span class="o">-</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">real</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">real</span> <span class="o">-</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">real</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">target</span> <span class="o">-</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">mapping</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="nx">real</span><span class="o">:</span> <span class="mf">0</span><span class="p">,</span>
    <span class="nx">target</span><span class="o">:</span> <span class="mf">0</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">real</span><span class="o">:</span> <span class="mf">30</span><span class="p">,</span>
    <span class="nx">target</span><span class="o">:</span> <span class="mf">50</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">real</span><span class="o">:</span> <span class="mf">60</span><span class="p">,</span>
    <span class="nx">target</span><span class="o">:</span> <span class="mf">80</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">real</span><span class="o">:</span> <span class="mf">100</span><span class="p">,</span>
    <span class="nx">target</span><span class="o">:</span> <span class="mf">100</span>
<span class="p">}];</span>


<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;15&quot;</span><span class="p">,</span> <span class="nx">adjustProgress</span><span class="p">(</span><span class="mf">15</span><span class="p">,</span> <span class="nx">mapping</span><span class="p">));</span>  <span class="c1">// 15 25</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;25&quot;</span><span class="p">,</span> <span class="nx">adjustProgress</span><span class="p">(</span><span class="mf">25</span><span class="p">,</span> <span class="nx">mapping</span><span class="p">));</span> <span class="c1">// 25 41.66666666666667</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;50&quot;</span><span class="p">,</span> <span class="nx">adjustProgress</span><span class="p">(</span><span class="mf">50</span><span class="p">,</span> <span class="nx">mapping</span><span class="p">));</span> <span class="c1">// 50 70</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;60&quot;</span><span class="p">,</span> <span class="nx">adjustProgress</span><span class="p">(</span><span class="mf">60</span><span class="p">,</span> <span class="nx">mapping</span><span class="p">));</span> <span class="c1">// 60 80</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">,</span> <span class="nx">adjustProgress</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span> <span class="nx">mapping</span><span class="p">));</span> <span class="c1">// 100 100</span>
</code></pre></div>

<h2 id="_5">滑滚动页面到顶部</h2>
<p><strong>代码</strong></p>
<p>PC端滚动的根元素是<code>document.documentElement</code>,  <br />
移动端滚动的的根元素是<code>document.body</code>,  <br />
有一个更好的属性<code>document.scrollingElement</code>能自己识别文档的滚动元素， 其在PC端等于<code>document.documentElement</code>, 其在移动端等于<code>document.body</code></p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span> <span class="nt">smooth</span> <span class="nt">选项在Safari上支持不好</span>
<span class="nt">function</span> <span class="nt">scrollToTop</span><span class="o">()</span><span class="p">{</span>
    <span class="err">window.scrollTo({</span>
        <span class="k">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="kc">top</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">behavior</span><span class="o">:</span> <span class="err">&#39;</span><span class="kc">smooth</span>
    <span class="p">}</span><span class="o">)</span>
<span class="err">}</span>

<span class="nt">function</span> <span class="nt">scrollToTop</span><span class="o">()</span> <span class="p">{</span>
    <span class="err">let</span> <span class="err">scrollTop</span> <span class="err">=</span> <span class="err">document.documentElement.scrollTop</span> <span class="err">||</span> <span class="err">document.body.scrollTop</span><span class="p">;</span>
    <span class="err">if</span> <span class="err">(scrollTop</span> <span class="err">&gt;</span> <span class="err">0)</span> <span class="err">{</span>
        <span class="err">window.requestAnimationFrame(scrollToTop)</span><span class="p">;</span>
        <span class="err">window.scrollTo(0,</span> <span class="err">scrollTop</span> <span class="err">-</span> <span class="err">scrollTop</span> <span class="err">/</span> <span class="err">8)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="err">}</span><span class="o">;</span>
</code></pre></div>

<h2 id="_6">禁止选择和复制</h2>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="s1">&#39;contextmenu&#39;</span><span class="p">,</span> <span class="s1">&#39;selectstart&#39;</span><span class="p">,</span> <span class="s1">&#39;copy&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>

<p>当然也有CSS方案  </p>
<div class="codehilite"><pre><span></span><code><span class="nt">body</span> <span class="p">{</span>
    <span class="kp">-moz-</span><span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
    <span class="kp">-webkit-</span><span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
    <span class="kp">-ms-</span><span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
    <span class="kp">-khtml-</span><span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
    <span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_7">禁止图片拖拽</h2>
<p><strong>代码</strong>  </p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="s1">&#39;dragstart&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>

<h2 id="id">自增长ID</h2>
<p>自己生产自增长的ID值，当然可以更复杂一些。</p>
<p><strong>代码</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nv">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">;</span>
<span class="nv">function</span> <span class="nv">getId</span><span class="ss">()</span> {
    <span class="k">return</span> <span class="nv">id</span><span class="o">++</span><span class="c1">;</span>
}
</code></pre></div>

<p><strong>示例</strong></p>
<div class="codehilite"><pre><span></span><code>console.log(getId()); // 1
console.log(getId()); // 2
</code></pre></div>

<h2 id="_8">写在后面</h2>
<p>写作不易，你的一赞一评，就是我前行的最大动力。</p><h1>三千文字，也没写好 Function.prototype.call</h1><h2 id="_1">前言</h2>
<p><code>Function.prototype.call</code>，手写系列，万文面试系列，必会系列必包含的内容，足见其在前端的分量。 <br />
本文基于<strong>MDN</strong> 和 <strong>ECMA</strong> 标准，和大家一起从新认识<code>call</code>。    </p>
<p>涉及知识点：
1. <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/undefined">undefined</a>
2. <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/void">void 一元运算符</a> <br />
3. <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Strict_mode">严格模式</a>和非严格模式
4. 浏览器和nodejs环境识别
5. 函数副作用 （纯函数）
6. <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/eval">eval</a>
7. <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP">Content-Security-Policy</a>
8. <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/delete">delete</a> 
9. <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function">new Function</a> <br />
10. <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze">Object.freeze</a>
11. 对象属性检查
12. 面试现场
13. ECMA规范和浏览器厂商之间的爱恨情仇</p>
<h2 id="_2">掘金流行的版本</h2>
<p>面试官的问题： <br />
<strong>麻烦你手写一下<code>Function.prototype.call</code></strong></p>
<h3 id="es6">基于<code>ES6的拓展运算符</code>版本</h3>
<div class="codehilite"><pre><span></span><code><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">call</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="nb">window</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">arg</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">arguments</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span> 
    <span class="nx">context</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">](...</span><span class="nx">arg</span><span class="p">);</span>
    <span class="k">delete</span> <span class="nx">context</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<p>这个版本，应该不是面试官想要的真正答案。不做太多解析。</p>
<h3 id="eval">基于<code>eval</code>的版本</h3>
<div class="codehilite"><pre><span></span><code><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">call</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">context</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="k">new</span>  <span class="nb">Object</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;arguments[&#39;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;context.fn(&#39;</span> <span class="o">+</span> <span class="nx">arr</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
  <span class="k">delete</span> <span class="nx">context</span><span class="p">.</span><span class="nx">fn</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>这个版本值得完善的地方
1. <code>this</code> 是不是函数没有进行判断
2. 使用undefined进行判断，安全不安全 <br />
    undefined 可能被改写，（高版本浏览器已做限制）。
3. 直接使用window作为默认上下文，过于武断。 <br />
    脚本运行环境，浏览器？ nodejs？  <br />
    函数运行模式，严格模式，非严格模式？
4. <code>eval</code> 一定会被允许执行吗
5. delete context.fn 有没有产生副作用 <br />
    context上要是原来有fn属性呢</p>
<p>在我们真正开始写<code>Function.prototype.call</code>之前，还是先来看看MDN和 ECMA是怎么定义她的。</p>
<h2 id="mdn-call">MDN call 的说明</h2>
<h3 id="_3">语法</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span> <span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">,</span> <span class="p">...)</span>
</code></pre></div>

<h3 id="_4">参数</h3>
<p><code>thisArg</code>   </p>
<p>可选的。在 function 函数运行时使用的 this 值。请注意，this可能不是该方法看到的实际值：如果这个函数处于<strong>非严格模式下</strong>，则指定为 null 或 undefined 时会自动替换为指向<strong>全局对象</strong>，<strong>原始值会被包装</strong>。 <br />
<code>arg1, arg2, ...</code>  <br />
指定的参数列表。</p>
<h3 id="_5">透露的信息</h3>
<p>这里透露了几个信息，我已经加粗标注：
1. 非严格模式，对应的有严格模式
2. 这里说的是指向 全局对象，没有说是<code>window</code>。当然MDN这里说是window也没太大问题。我想补充的是 <code>nodejs</code> 也实现了 ES标准。所以我们实现的时候，是不是要考虑到 <code>nodejs</code>环境呢。
3. 原始值会被包装。怎么个包装呢，<code>Object(val)</code>，即完成了对原始值<code>val</code>的包装。</p>
<h3 id="es">ES标准</h3>
<p>在 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/call">Function.prototype.call() - JavaScript | MDN</a>的底部罗列了ES规范版本，每个版本都有<code>call实现的</code>说明。</p>
<p>我们实现的，是要基于ES的某个版本来实现的。</p>
<p>因为ES的版本不同，实现的细节可能不一样，实现的环境也不一样。</p>
<table class="standard-table">
 <tbody>
  <tr>
   <th scope="col">规范版本</th>
   <th scope="col">状态</th>
   <th scope="col">说明</th>
  </tr>
  <tr>
   <td><a href="https://www.ecma-international.org/publications/files/ECMA-ST-ARCH/ECMA-262,%201st%20edition,%20June%201997.pdf" hreflang="en" lang="en" class="external" title="ECMAScript 1st Edition (ECMA-262)" rel=" noopener">ECMAScript 1st Edition (ECMA-262)</a></td>
   <td><span class="spec-standard">Standard</span></td>
   <td>初始定义。在 JavaScript 1.3 中实现。</td>
  </tr>
  <tr>
   <td><a href="https://www.ecma-international.org/ecma-262/5.1/#sec-15.3.4.4" hreflang="en" lang="en" class="external" rel=" noopener">ECMAScript 5.1 (ECMA-262)<br><small lang="zh-CN">Function.prototype.call</small></a></td>
   <td><span class="spec-standard">Standard</span></td>
   <td></td>
  </tr>
  <tr>
   <td><a href="https://www.ecma-international.org/ecma-262/6.0/#sec-function.prototype.call" hreflang="en" lang="en" class="external" rel=" noopener">ECMAScript 2015 (6th Edition, ECMA-262)<br><small lang="zh-CN">Function.prototype.call</small></a></td>
   <td><span class="spec-standard">Standard</span></td>
   <td></td>
  </tr>
  <tr>
   <td><a href="https://tc39.es/ecma262/#sec-function.prototype.call" hreflang="en" lang="en" class="external" rel=" noopener">ECMAScript (ECMA-262)<br><small lang="zh-CN">Function.prototype.call</small></a></td>
   <td><span class="spec-living">Living Standard</span></td>
   <td></td>
  </tr>
 </tbody>
</table>

<p>在ES3标准中关于<code>call</code>的规范说明在<code>11.2.3 Function Calls</code>, 直接搜索就能查到。</p>
<p>我们今天主要是基于2009年ES5标准下来实现<code>Function.prototype.call</code>，有人可能会说，你这，为嘛不在 ES3标准下实现，因为ES5下能涉及更多的知识点。</p>
<h2 id="undefined">不可靠的undefined</h2>
<p><code>(context == null || context == undefined) ? window : new  Object(context)</code></p>
<p>上面代码的 <code>undefined</code> 不一定是可靠的。</p>
<p>引用一段MDN的话：</p>
<blockquote>
<p>在现代浏览器（JavaScript 1.8.5/Firefox 4+），自ECMAscript5标准以来undefined是一个不能被配置（non-configurable），不能被重写（non-writable）的属性。即便事实并非如此，也要避免去重写它。</p>
</blockquote>
<p>在没有交代上下文的情况使用 <code>void 0</code> 比直接使用 <code>undefined</code> 更为安全。</p>
<p>有些同学可能没见过undefined被改写的情况，没事，来一张图：</p>
<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a3c24cb13a04465b9657bac9a8dbaf7f~tplv-k3u1fbpfcp-watermark.image" /></p>
<p><code>void</code> 这个一元运算法除了这个 准备返回 <code>undefined</code>外， 还有另外两件常见的用途：
1. a标签的href，就是什么都不做 <br />
<code>&lt;a href="javascript:void(0);"&gt;</code>   </p>
<ol>
<li>IIFE立即执行</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="p">;</span><span class="k">void</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="p">}(</span><span class="s2">&quot;你好啊&quot;</span><span class="p">);</span>
</code></pre></div>

<p>当然更直接的方式是:</p>
<div class="codehilite"><pre><span></span><code><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="p">})(</span><span class="s2">&quot;你好啊&quot;</span><span class="p">);</span>
</code></pre></div>

<h2 id="nodejs">浏览器和nodejs环境识别</h2>
<p>浏览器环境:</p>
<div class="codehilite"><pre><span></span><code><span class="k">typeof</span> <span class="nx">self</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">self</span> <span class="o">===</span> <span class="nx">self</span>
</code></pre></div>

<p>nodejs环境：</p>
<div class="codehilite"><pre><span></span><code><span class="k">typeof</span> <span class="nx">global</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">global</span> <span class="o">===</span> <span class="nx">global</span>
</code></pre></div>

<p>现在已经有 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/globalThis">globalThis</a>, 在高版本浏览器和nodejs里面都支持。 </p>
<p>显然，在我们的这个场景下，还不能用，但是其思想可以借鉴：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">getGlobal</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">self</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">window</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">global</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">global</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;unable to locate global object&#39;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="_6">严格模式</h2>
<h3 id="_7">是否支持严格模式</h3>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode">Strict mode</a> 严格模式，是ES5引入的特性。那我们怎么验证你的环境是不是支持严格模式呢？   </p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">hasStrictMode</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span> 
 <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
 <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">}());</span>
</code></pre></div>

<p>正常情况都会返回<code>true</code>,放到IE8里面执行：</p>
<p><img alt="image.png" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/483ba137a3e54dd8af535435df5fe325~tplv-k3u1fbpfcp-watermark.image" /></p>
<p>在非严格模式下，函数的调用上下文（this的值）是全局对象。在严格模式下，调用上下文是undefined。</p>
<h3 id="_8">是否处于严格模式下</h3>
<p>知道是不是支持严格模式，还不够，我们还要知道我们是不是处于严格模式下。   </p>
<p>如下的代码可以检测，是不是处于严格模式： </p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">isStrict</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
　　<span class="k">return</span> <span class="k">this</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">}());</span>
</code></pre></div>

<p>这段代码在支持严格模式的浏览器下和<code>nodejs</code>环境下都是工作的。</p>
<h2 id="_9">函数副作用</h2>
<div class="codehilite"><pre><span></span><code>  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;context.fn(&#39;</span> <span class="o">+</span> <span class="nx">arr</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
  <span class="k">delete</span> <span class="nx">context</span><span class="p">.</span><span class="nx">fn</span><span class="p">;</span>
</code></pre></div>

<p>如上的代码直接删除了context上的<code>fn</code>属性，如果原来的context上有<code>fn</code>属性，那会不会丢失呢？</p>
<p>我们采用<code>eval</code>版本的<code>call</code>, 执行下面的代码</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">fn</span><span class="o">:</span> <span class="s2">&quot;i am fn&quot;</span><span class="p">,</span>
  <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;i am msg&quot;</span>
<span class="p">}</span>

<span class="nx">log</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>  <span class="c1">// i am msg</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;msg:&quot;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span> <span class="c1">// i am msg</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;fn:&quot;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">fn</span><span class="p">);</span> <span class="c1">// fn: undedined</span>
</code></pre></div>

<p>可以看到context的<code>fn</code>属性已经被干掉了，是破坏了入参，产生了不该产生的副作用。<br />
与副作用对应的是函数式编程中的 <strong>纯函数</strong>。 </p>
<p>对应的我们要采取行动，基本两种思路：
1. 造一个不会重名的属性
2. 保留现场然后还原现场</p>
<p>都可以，不过觉得 方案2更简单和容易实现：<br />
基本代码如下：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">propertyName</span> <span class="o">=</span> <span class="s2">&quot;__fn__&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">originVal</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">hasOriginVal</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">propertyName</span><span class="p">)</span>
<span class="k">if</span><span class="p">(</span><span class="nx">hasOriginVal</span><span class="p">){</span>
    <span class="nx">originVal</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span>
<span class="p">}</span>

<span class="p">......</span> <span class="c1">// 其他代码</span>

<span class="k">if</span><span class="p">(</span><span class="nx">hasOriginVal</span><span class="p">){</span>
    <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">originVal</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="eval_1">基于<code>eval</code>的实现，基本如下</h2>
<p>基于标准<a href="https://262.ecma-international.org/5.1/#sec-15.3.4.4">ECMAScript 5.1 (ECMA-262)
Function.prototype.call</a></p>
<div class="codehilite"><pre><span></span><code><span class="nx">When</span> <span class="nx">the</span> <span class="nx">call</span> <span class="nx">method</span> <span class="nx">is</span> <span class="nx">called</span> <span class="nx">on</span> <span class="nx">an</span> <span class="nx">object</span> <span class="nx">func</span> <span class="kd">with</span> <span class="nx">argument</span> <span class="nx">thisArg</span> <span class="nx">and</span> <span class="nx">optional</span> <span class="nx">arguments</span> <span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span> <span class="nx">etc</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">steps</span> <span class="nx">are</span> <span class="nx">taken</span><span class="o">:</span>

<span class="mf">1.</span> <span class="nx">If</span> <span class="nx">IsCallable</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="nx">is</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">then</span> <span class="k">throw</span> <span class="nx">a</span> <span class="nx">TypeError</span> <span class="nx">exception</span><span class="p">.</span>

<span class="mf">2.</span> <span class="nx">Let</span> <span class="nx">argList</span> <span class="nx">be</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">List</span><span class="p">.</span>

<span class="mf">3.</span> <span class="nx">If</span> <span class="k">this</span> <span class="nx">method</span> <span class="nx">was</span> <span class="nx">called</span> <span class="kd">with</span> <span class="nx">more</span> <span class="nx">than</span> <span class="nx">one</span> <span class="nx">argument</span> <span class="nx">then</span> <span class="k">in</span> <span class="nx">left</span> <span class="nx">to</span> <span class="nx">right</span> 
<span class="nx">order</span> <span class="nx">starting</span> <span class="kd">with</span> <span class="nx">arg1</span> <span class="nx">append</span> <span class="nx">each</span> <span class="nx">argument</span> <span class="k">as</span> <span class="nx">the</span> <span class="nx">last</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">argList</span>

<span class="mf">4.</span> <span class="nx">Return</span> <span class="nx">the</span> <span class="nx">result</span> <span class="k">of</span> <span class="nx">calling</span> <span class="nx">the</span> <span class="p">[[</span><span class="nx">Call</span><span class="p">]]</span> <span class="nx">internal</span> <span class="nx">method</span> <span class="k">of</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">providing</span> 
<span class="nx">thisArg</span> <span class="k">as</span> <span class="nx">the</span> <span class="k">this</span> <span class="nx">value</span> <span class="nx">and</span> <span class="nx">argList</span> <span class="k">as</span> <span class="nx">the</span> <span class="nx">list</span> <span class="k">of</span> <span class="nx">arguments</span><span class="p">.</span>
<span class="nx">The</span> <span class="nx">length</span> <span class="nx">property</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">call</span> <span class="nx">method</span> <span class="nx">is</span> <span class="mf">1.</span>

<span class="nx">NOTE</span> <span class="nx">The</span> <span class="nx">thisArg</span> <span class="nx">value</span> <span class="nx">is</span> <span class="nx">passed</span> <span class="nx">without</span> <span class="nx">modification</span> <span class="k">as</span> <span class="nx">the</span> <span class="k">this</span> <span class="nx">value</span><span class="p">.</span> <span class="nx">This</span> <span class="nx">is</span> <span class="nx">a</span> 
<span class="nx">change</span> <span class="k">from</span> <span class="nx">Edition</span> <span class="mf">3</span><span class="p">,</span> <span class="nx">where</span> <span class="nx">a</span> <span class="kc">undefined</span> <span class="nx">or</span> <span class="kc">null</span> <span class="nx">thisArg</span> <span class="nx">is</span> <span class="nx">replaced</span> <span class="kd">with</span> <span class="nx">the</span>  
<span class="nx">global</span> <span class="nx">object</span> <span class="nx">and</span> <span class="nx">ToObject</span> <span class="nx">is</span> <span class="nx">applied</span> <span class="nx">to</span> <span class="nx">all</span> <span class="nx">other</span> <span class="nx">values</span> <span class="nx">and</span> <span class="nx">that</span> <span class="nx">result</span> <span class="nx">is</span> <span class="nx">passed</span> 
<span class="k">as</span> <span class="nx">the</span> <span class="k">this</span> <span class="nx">value</span><span class="p">.</span>
</code></pre></div>

<p>对我们比较重要的是 <code>1</code>和 <code>Note</code>:</p>
<p>看看我们的基础实现</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">hasStrictMode</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">}());</span>

<span class="kd">var</span> <span class="nx">isStrictMode</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">getGlobal</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">self</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">window</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">global</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">global</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;unable to locate global object&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">fn</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getContext</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">isStrict</span> <span class="o">=</span> <span class="nx">isStrictMode</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasStrictMode</span> <span class="o">||</span> <span class="p">(</span><span class="nx">hasStrictMode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isStrict</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">context</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">context</span> <span class="o">===</span> <span class="k">void</span> <span class="mf">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">getGlobal</span><span class="p">()</span> <span class="o">:</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 严格模式下, 妥协方案</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">call</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 不可以被调用</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="k">this</span> <span class="o">+</span> <span class="s1">&#39; is not a function&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 获取上下文</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">getContext</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

    <span class="c1">// 更为稳妥的是创建唯一ID, 以及检查是否有重名</span>
    <span class="kd">var</span> <span class="nx">propertyName</span> <span class="o">=</span> <span class="s2">&quot;__fn__&quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">originVal</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">hasOriginVal</span> <span class="o">=</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">)</span> <span class="o">?</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">propertyName</span><span class="p">)</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasOriginVal</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">originVal</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>    

    <span class="c1">// 采用string拼接</span>
    <span class="kd">var</span> <span class="nx">argStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">argStr</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">len</span> <span class="o">-</span> <span class="mf">1</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;arguments[&#39;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span> <span class="o">:</span> <span class="s1">&#39;arguments[&#39;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39;],&#39;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;ctx[&quot;&#39;</span> <span class="o">+</span> <span class="nx">propertyName</span> <span class="o">+</span> <span class="s1">&#39;&quot;](&#39;</span> <span class="o">+</span> <span class="nx">argStr</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>

    <span class="c1">// 还原现场</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasOriginVal</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">originVal</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>当前版依旧存在问题， <br />
1. 严格模式下，我们用依然用<code>Obeject</code>进行了封装。
<strong>会导致严格模式下传递非对象的时候，this的指向是不准的， 不得以的妥协。</strong> 
 哪位同学有更好的方案，敬请指导。</p>
<ol>
<li>虽说我们把临时的属性名变得难以重名，但是如果重名，而函数调用中真调用了此方法，可能会导致异常行为。   </li>
</ol>
<p>所以完美的解决方法，就是产生一个UID.</p>
<ol>
<li><code>eval</code>的执行，可能会被 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP">Content-Security-Policy</a> 阻止</li>
</ol>
<p>大致的提示信息如下：</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="nx">Report</span> <span class="nx">Only</span><span class="p">]</span> <span class="nx">Refused</span> <span class="nx">to</span> <span class="nx">evaluate</span> <span class="nx">a</span> <span class="nx">string</span> <span class="k">as</span> <span class="nx">JavaScript</span> <span class="nx">because</span> <span class="s1">&#39;unsafe-eval&#39;</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">an</span>   
<span class="nx">allowed</span> <span class="nx">source</span> <span class="k">of</span> <span class="nx">script</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">Content</span> <span class="nx">Security</span> <span class="nx">Policy</span> <span class="nx">directive</span><span class="o">:</span> <span class="err">&quot;</span><span class="nx">script</span><span class="o">-</span><span class="nx">src</span> 
<span class="p">.........</span>
</code></pre></div>

<p><img alt="image.png" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67083b47e4264be1a33f12a23c106d26~tplv-k3u1fbpfcp-watermark.image" /></p>
<p>前面两条都应该还能接受，至于第三条，我们不能妥协。</p>
<p>这就得请出下一位嘉宾, <code>new Function</code>。</p>
<h2 id="new-function"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function">new Function</a></h2>
<blockquote>
<p>new Function ([arg1[, arg2[, ...argN]],] functionBody)</p>
</blockquote>
<p>其基本格式如上，最后一个为函数体。</p>
<p>举个简单的例子：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">sum</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;return a + b&#39;</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sum</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="mf">6</span><span class="p">));</span>
<span class="c1">// expected output: 8</span>
</code></pre></div>

<p>我们<code>call</code>的参数个数是不固定，思路就是从<code>arguments</code>动态获取。</p>
<p>这里我们的实现借用<a href="https://juejin.cn/post/6844903728147857415">面试官问：能否模拟实现JS的call和apply方法</a> 实现方法：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">generateFunctionCode</span><span class="p">(</span><span class="nx">argsArrayLength</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="s1">&#39;return arguments[0][arguments[1]](&#39;</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">argsArrayLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">){</span>
            <span class="nx">code</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="s1">&#39;arguments[2][&#39;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">code</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
    <span class="c1">// return arguments[0][arguments[1]](arg1, arg2, arg3...)</span>
    <span class="k">return</span> <span class="nx">code</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="new-function_1">基于 new Function的实现</h2>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">hasStrictMode</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">}());</span>

<span class="kd">var</span> <span class="nx">isStrictMode</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">getGlobal</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">self</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">window</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">global</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">global</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;unable to locate global object&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">fn</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getContext</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">isStrict</span> <span class="o">=</span> <span class="nx">isStrictMode</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasStrictMode</span> <span class="o">||</span> <span class="p">(</span><span class="nx">hasStrictMode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isStrict</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">context</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">context</span> <span class="o">===</span> <span class="k">void</span> <span class="mf">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">getGlobal</span><span class="p">()</span> <span class="o">:</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 严格模式下, 妥协方案</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">generateFunctionCode</span><span class="p">(</span><span class="nx">argsLength</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="s1">&#39;return arguments[0][arguments[1]](&#39;</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">argsLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">){</span>
            <span class="nx">code</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="s1">&#39;arguments[2][&#39;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">code</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
    <span class="c1">// return arguments[0][arguments[1]](arg1, arg2, arg3...)</span>
    <span class="k">return</span> <span class="nx">code</span><span class="p">;</span>
<span class="p">}</span>


<span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">call</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 不可以被调用</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="k">this</span> <span class="o">+</span> <span class="s1">&#39; is not a function&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 获取上下文</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">getContext</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

    <span class="c1">// 更为稳妥的是创建唯一ID, 以及检查是否有重名</span>
    <span class="kd">var</span> <span class="nx">propertyName</span> <span class="o">=</span> <span class="s2">&quot;__fn__&quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">originVal</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">hasOriginVal</span> <span class="o">=</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">)</span> <span class="o">?</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">propertyName</span><span class="p">)</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasOriginVal</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">originVal</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">argArr</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">argArr</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="nx">generateFunctionCode</span><span class="p">(</span><span class="nx">argArr</span><span class="p">.</span><span class="nx">length</span><span class="p">))(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">,</span> <span class="nx">argArr</span><span class="p">);</span>

    <span class="c1">// 还原现场</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasOriginVal</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">originVal</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_10">评论区问题收集</h2>
<p>评论区最精彩：<br />
1. 为什么不用 <code>Symbol</code>
因为是基于ES5的标准来写，如果使用<code>Symbol</code>，那拓展运算符也可以使用。 考察的知识面自然少很多。</p>
<ol>
<li>
<p>支付宝小程序evel、new Function都是不给用的
这样子的话，可能真的无能为力了。 </p>
</li>
<li>
<p>Object.freeze后的对象是不可以添加属性的
感谢<a href="https://juejin.cn/user/1292681404747374">虚鲲菜菜子</a>的指正，其文章<a href="https://juejin.cn/post/6935736906558734350">手写 call 与 原生 Function.prototype.call 的区别</a> 推荐大家细读。</p>
</li>
</ol>
<p>如下的代码，严格模式下会报错，非严格模式复制不成功：</p>
<div class="codehilite"><pre><span></span><code><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">a</span><span class="o">:</span> <span class="mf">1</span><span class="p">,</span>
    <span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;msg:&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="nx">context</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>

<span class="p">};</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">fn</span><span class="p">);</span>

<span class="nx">VM111</span> <span class="nx">call</span><span class="o">:</span><span class="mf">12</span> <span class="nx">Uncaught</span> <span class="nx">TypeError</span><span class="o">:</span> <span class="nx">Cannot</span> <span class="nx">add</span> <span class="nx">property</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">object</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">extensible</span>
    <span class="nx">at</span> <span class="nx">VM49</span> <span class="nx">call</span><span class="o">:</span><span class="mf">12</span>
</code></pre></div>

<p>这种情况怎么办呢，我能想到的是两种方式：
1. 复制对象
2. <code>Obect.create</code>
这也算是一种妥协方法，毕竟链路还是变长了。</p>
<div class="codehilite"><pre><span></span><code><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">a</span><span class="o">:</span> <span class="mf">1</span><span class="p">,</span>
    <span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;msg:&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span>  <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>

<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;fn:&quot;</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">fn</span><span class="p">);</span>  <span class="c1">// fn: function</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ctx.a&quot;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>  <span class="c1">// ctx.a 1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ctx.fn&quot;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">fn</span><span class="p">);</span> <span class="c1">// ctx.fn ƒ (){}</span>
</code></pre></div>

<h2 id="_11">小结</h2>
<p>回顾一下依旧存在的问题
1. 严格模式下，我们用依然需要用<code>Object</code>进行了封装基础数据类型
<strong>会导致严格模式下传递非对象的时候，this的指向是不准的， 不得以的妥协。</strong> 
 哪位同学有更好的方案，敬请指导。</p>
<ol>
<li>
<p>虽说我们把临时的属性名变得难以重名，但是如果重名，<strong>而函数调用中真调用了此方法，可能会导致异常行为</strong></p>
</li>
<li>
<p>小程序等环境可能禁止使用<code>eval</code>和<code>new Function</code></p>
</li>
<li>
<p>对象被冻结，<code>call</code>执行函数中的<code>this</code>不是<strong>真正</strong>传入的上下文对象。</p>
</li>
</ol>
<p>所以，我还是修改标题为<strong>三千文字，也没写好 Function.prototype.call</strong></p>
<h2 id="_12">面试现场</h2>
<p>一个手写<code>call</code>涉及到不少的知识点，本人水平有限，如有遗漏，敬请谅解和补充。  </p>
<p>当面试官问题的时候，你要清楚自己面试的岗位，是P6,P7还是P8。 <br />
是高级开发还是前端组长，抑或是前端负责人。 <br />
岗位不一样，面试官当然期望的答案也不一样。</p>
<h2 id="_13">写在最后</h2>
<p>写作不易，您的支持就是我前行的最大动力。  </p>
<h2 id="_14">参考和引用</h2>
<blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/call">Function.prototype.call() - JavaScript | MDN</a> <br />
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode">Strict mode - JavaScript | MDN</a>  <br />
<a href="https://caniuse.com/use-strict">ECMAScript 5 Strict Mode</a><br />
<a href="https://yanhaijing.com/es5">ES合集</a> <br />
<a href="https://juejin.cn/post/6844903773979033614">手写call、apply、bind实现及详解</a> <br />
<a href="https://juejin.cn/post/6977563249650696206">call、apply、bind实现原理</a> <br />
<a href="https://juejin.cn/post/6844903728147857415">面试官问：能否模拟实现JS的call和apply方法</a></p>
</blockquote><h1>那些你熟悉而又陌生的函数  </h1><blockquote>
<p>这是我参与更文挑战的第10天，活动详情查看： <a href="https://juejin.cn/post/6967194882926444557">更文挑战</a></p>
</blockquote>
<h2 id="_1">前言</h2>
<p>五层境界</p>
<ol>
<li>我不知道我不知道</li>
<li>我知道我不知道</li>
<li>我知道我知道</li>
<li>我不知道我知道</li>
</ol>
<p>第三层境界以上的兄台，可以直接离开了。</p>
<p>至于第五层境界，无需知道还是不知道。</p>
<p>废话不多说，进入正题，一起探索那些你熟悉和又陌生的函数。</p>
<h2 id="_2">目录</h2>
<p>因为手机端目录不显示，单独写一份：
* <a href="#__setTimeout"> setTimeout &amp;&amp; setInterval</a>
* <a href="#__parse"> JSON.parse</a> 
* <a href="#__stringify"> JSON.stringify</a> 
* <a href="#__addEventListener"> addEventListener</a> 
* <a href="#__from"> Array.from</a> 
* <a href="#__replace"> String.replace</a> 
* <a href="__getComputeStyle">window.getComputeStyle</a>
* <a href="__localStorage">localStorage.setItem</a>
* <a href="#__console"> 控制台特有的</a></p>
<p><span id="setTimeout"></span></p>
<h2 id="settimeout-setinterval"><a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout">setTimeout</a> &amp;&amp; <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval">setInterval</a></h2>
<p>语法</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">timeoutID</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">[,</span> <span class="nx">delay</span><span class="p">,</span> <span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">,</span> <span class="p">...]);</span>
<span class="kd">var</span> <span class="nx">timeoutID</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">[,</span> <span class="nx">delay</span><span class="p">]);</span>
<span class="kd">var</span> <span class="nx">timeoutID</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">code</span><span class="p">[,</span> <span class="nx">delay</span><span class="p">]);</span>
</code></pre></div>

<p>我们最常用的是语法中的第二种 <br />
<code>var timeoutID = scope.setTimeout(function[, delay]);</code> <br />
举个例子</p>
<div class="codehilite"><pre><span></span><code><span class="nx">setTimeout</span><span class="p">(()=&gt;{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`当前时间:</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="p">},</span> <span class="mf">1000</span><span class="p">)</span>
</code></pre></div>

<p>接着我们看再看第三种 <code>setTimeout(code[, delay])</code>, <code>code</code>就是代码字符串，其底层实现就是调用<code>eval</code>，你可能问题怎么知道的，因为MDN对这个code参数有解释。</p>
<blockquote>
<p>code <br />
An alternative syntax that allows you to include a string instead of a function, which is compiled and executed when the timer expires. This syntax is not recommended for the same  reasons that make using <strong>eval()</strong> a security risk.</p>
</blockquote>
<p>刚才的代码就等于下面的代码</p>
<div class="codehilite"><pre><span></span><code><span class="nx">setTimeout</span><span class="p">(</span> <span class="sb">`console.log(&quot;当前时间:</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">&quot;)`</span><span class="p">,</span> <span class="mf">1000</span><span class="p">)</span>
</code></pre></div>

<p>这里有些掘友可能就直接贴到浏览器的控制台去测试，我得提醒你，很可能你不能正确执行，而是收到类似下面的提示</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="nx">Report</span> <span class="nx">Only</span><span class="p">]</span> <span class="nx">Refused</span> <span class="nx">to</span> <span class="nx">evaluate</span> <span class="nx">a</span> <span class="nx">string</span> <span class="k">as</span> <span class="nx">JavaScript</span> <span class="nx">because</span> <span class="s1">&#39;unsafe-eval&#39;</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">an</span>   
<span class="nx">allowed</span> <span class="nx">source</span> <span class="k">of</span> <span class="nx">script</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">Content</span> <span class="nx">Security</span> <span class="nx">Policy</span> <span class="nx">directive</span><span class="o">:</span> <span class="err">&quot;</span><span class="nx">script</span><span class="o">-</span><span class="nx">src</span> 
<span class="p">.........</span>
</code></pre></div>

<p>这是因为CSP拦截了，更多关于CSP的内容可以查看<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy">Content-Security-Polic</a> 或者 阮大神的 <a href="https://www.ruanyifeng.com/blog/2016/09/csp.html">Content Security Policy 入门教程</a></p>
<p>我们最后看第一种 <code>setTimeout(function[, delay, arg1, arg2, ...])</code>, 从第三个参数开始，都会传给回调函数， 我们看一段代码</p>
<div class="codehilite"><pre><span></span><code><span class="nx">setTimeout</span><span class="p">((</span><span class="nx">startTime</span><span class="p">,</span> <span class="nx">tip</span><span class="p">)=&gt;{</span>
    <span class="kd">const</span> <span class="nx">endTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;时间已经过去了&quot;</span><span class="p">,</span> <span class="nx">endTime</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">,</span> <span class="s2">&quot;ms,&quot;</span> <span class="p">,</span><span class="nx">tip</span><span class="p">);</span>  <span class="c1">// 时间已经过去了 501 ms, 该休息了</span>
<span class="p">},</span><span class="mf">500</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span> <span class="s2">&quot;该休息了&quot;</span><span class="p">);</span>
</code></pre></div>

<p>其实clearTimeout,clearInterval也有一点小意思，clearTimeout能不能清除setInterval？那反过来呢？</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">ticket</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;100ms后执行&quot;</span><span class="p">);</span>
<span class="p">},</span><span class="mf">100</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">ticket2</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;200ms后执行&quot;</span><span class="p">);</span>
<span class="p">},</span><span class="mf">200</span><span class="p">);</span>
<span class="nx">clearInterval</span><span class="p">(</span><span class="nx">ticket</span><span class="p">);</span>

<span class="c1">// 200ms后执行</span>
</code></pre></div>

<p>有人会说，这这这......，年轻人，不要较真。</p>
<p>题外话:</p>
<p>有传说 setTimeout <code>4ms</code>的最小间隔。<br />
这是有前提的，如果四次以上的嵌套调用<code>setTimeout</code>， 第五次起，才会有这个<code>4ms</code>的约束。 <br />
更多可以参见 HTML standard <a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers">timers-and-user-prompts</a>。<br />
你也可以去<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout#reasons_for_delays">MDN setTimeout</a>亲手测测。</p>
<p>这里补充一句，标准归标准，实现归实现， 浏览器厂商那么多，哈。</p>
<p><span id="__parse"></span></p>
<h2 id="jsonparse"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse">JSON.parse</a></h2>
<p>语法</p>
<div class="codehilite"><pre><span></span><code><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
<span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">reviver</span><span class="p">)</span>
</code></pre></div>

<p>我们平时 99.99%的时候，都在使用第一种。</p>
<p><code>reviver</code>参数用TypeScript表示，差不多是这样子的<code>(key:string, value: any)=&gt; any</code>。</p>
<p><strong>如果复用程序只转换某些值而不转换其他值，那么一定要按原样返回所有未转换的值，否则，将从结果对象中删除这些值。</strong></p>
<p>看个例子, 转换成对象后， IDCard属性就没了。</p>
<div class="codehilite"><pre><span></span><code><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;tom&quot;</span><span class="p">,</span>
  <span class="nx">age</span><span class="o">:</span> <span class="mf">18</span><span class="p">,</span>
  <span class="nx">phone</span><span class="o">:</span> <span class="s2">&quot;15888787788&quot;</span><span class="p">,</span>
  <span class="nx">IDCard</span><span class="o">:</span> <span class="s2">&quot;xxxx&quot;</span>
<span class="p">}),</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)=&gt;{</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;IDCard&quot;</span><span class="p">){</span>
    <span class="k">return</span> <span class="kc">undefined</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>

<span class="p">});</span>   <span class="c1">// {name: &quot;tom&quot;, age: 18, phone: &quot;15888787788&quot;}</span>
</code></pre></div>

<p>这里有两点补充：
1. <strong>JSON.parse转换的时候，是深度优先遍历</strong>
2. <strong>最后一条key的值，是空值</strong></p>
<p>看代码：</p>
<div class="codehilite"><pre><span></span><code><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;{&quot;1&quot;: 1, &quot;2&quot;: 2, &quot;3&quot;: {&quot;4&quot;: 4, &quot;5&quot;: {&quot;6&quot;: 6}}}&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span> <span class="c1">// log the current property name, the last is &quot;&quot;.</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>     <span class="c1">// return the unchanged property value.</span>
<span class="p">});</span>

<span class="c1">// 1</span>
<span class="c1">// 2</span>
<span class="c1">// 4</span>
<span class="c1">// 6</span>
<span class="c1">// 5</span>
<span class="c1">// 3</span>
<span class="c1">// &quot;&quot;</span>
</code></pre></div>

<p><span id="__stringify"></span></p>
<h2 id="jsonstringify"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify</a></h2>
<p>语法</p>
<div class="codehilite"><pre><span></span><code><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">replacer</span><span class="p">)</span>
<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">replacer</span><span class="p">,</span> <span class="nx">space</span><span class="p">)</span>
</code></pre></div>

<p>第一种就不多说了。 </p>
<p>后两个参数的说明如下</p>
<blockquote>
<p>replacer 可选  </p>
</blockquote>
<ul>
<li>如果该参数是一个函数，则在序列化过程中，被序列化的值的每个属性都会经过该函数的转换和处理； </li>
<li>如果该参数是一个数组，则只有包含在这个数组中的属性名才会被序列化到最终的 JSON 字符串中；</li>
<li>如果该参数为 null 或者未提供，则对象所有的属性都会被序列化。</li>
</ul>
<blockquote>
<p>space 可选 <br />
指定缩进用的空白字符串，用于美化输出（pretty-print）；
* 如果参数是个数字，它代表有多少的空格；上限为10。该值若小于1，则意味着没有空格；
* 如果该参数为字符串（当字符串长度超过10个字母，取其前10个字母），该字符串将被作为空格；
* 如果该参数没有提供（或者为 null），将没有空格。</p>
</blockquote>
<p>到这里，有些同学吃惊一把。其实掘金有很多关于这的文章
* 爆款 <a href="https://juejin.cn/post/6844904016212672519#heading-27">你不知道的 JSON.stringify() 的威力</a>
* <a href="https://juejin.cn/post/6844903711127404557">有意思的JSON.parse、JSON.stringify</a>
* <a href="https://juejin.cn/post/6844904001801027592">深拷贝系列 ———— 自己实现一个JSON.stringify和JSON.parse</a></p>
<p>当然我说的两点：
* toJSON
* space参数</p>
<p><strong>toJSON</strong>： 当一个需要被转换的对象定义了toJSON方法， 会直接返回toJSON的值。
举个栗子：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
  <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;bar&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>      <span class="c1">// &#39;&quot;bar&quot;&#39;</span>
</code></pre></div>

<p><strong>space</strong>： 参数是用于美化转化后格式的，举个栗子: 保存<code>JSON</code>文件的时候，尤其有用。
当然，下面的代码你放到浏览器，有些浏览器可能看不出什么效果，在<code>nodejs</code>执行，然后保存文件就看到效果了。</p>
<div class="codehilite"><pre><span></span><code><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">uno</span><span class="o">:</span> <span class="mf">1</span><span class="p">,</span> <span class="nx">dos</span> <span class="o">:</span> <span class="mf">2</span> <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;\t&#39;</span><span class="p">)</span>
<span class="c1">// &#39;{            \</span>
<span class="c1">//     &quot;uno&quot;: 1, \</span>
<span class="c1">//     &quot;dos&quot;: 2  \</span>
<span class="c1">// }&#39;</span>
</code></pre></div>

<p><span id="__addEventListener"></span></p>
<h2 id="addeventlistener">addEventListener</h2>
<p>就这，就这，还怀疑我不会用。 我就真觉得，看到这里的有50%以上，就真不全会。
等看完，如果是真不全会的，麻烦评论区评论 <code>一起围观作者</code>。
;</p>
<div class="codehilite"><pre><span></span><code><span class="nx">target</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="nx">target</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">useCapture</span><span class="p">)</span>
</code></pre></div>

<p>四个9的可靠性，<code>99.9999%</code>的通知，都完全知道第三个参数是布尔值的情况。我也就不说了。</p>
<p><strong>options 可选</strong></p>
<p>可用的选项：
* capture:  Boolean，表示 listener 会在该类型的事件捕获阶段传播到该 EventTarget 时触发。
* once:  Boolean，表示 listener 在添加之后最多只调用一次。如果是 true， listener 会在其被调用之后自动移除。
* passive: Boolean，设置为true时，表示 listener 永远不会调用 preventDefault()。如果 listener 仍然调用了这个函数，客户端将会忽略它并抛出一个控制台警告。查看 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener#%E4%BD%BF%E7%94%A8_passive_%E6%94%B9%E5%96%84%E7%9A%84%E6%BB%9A%E5%B1%8F%E6%80%A7%E8%83%BD">使用 passive 改善的滚屏性能</a> 了解更多.
* signal：AbortSignal，该 AbortSignal 的 abort() 方法被调用时，监听器会被移除。</p>
<h3 id="once">once</h3>
<p>看到<code>once</code>是不是很熟悉，<code>EventEmitter</code>, <code>socket.io</code>等等是不是都有，这就是我们熟悉的那个啥模式。</p>
<p>其实 window本身一定程度上就是一个订阅发布中心：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">_dispatch</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">ev</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomEvent</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="p">{</span> <span class="nx">detail</span><span class="o">:</span> <span class="nx">data</span> <span class="p">});</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">ev</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">_on</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">_emit</span> <span class="o">=</span> <span class="nx">_dispatch</span><span class="p">;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">_once</span> <span class="o">=</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">once</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">_on</span><span class="p">(</span><span class="s2">&quot;event-x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;event-x 收到数据:&quot;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">detail</span><span class="p">);</span>
<span class="p">});</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">_once</span><span class="p">(</span><span class="s2">&quot;event-once&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;event-once 收到数据:&quot;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">detail</span><span class="p">);</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">once</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">});</span>  

<span class="nb">window</span><span class="p">.</span><span class="nx">_emit</span><span class="p">(</span><span class="s2">&quot;event-x&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">uid</span><span class="o">:</span> <span class="mf">100</span><span class="p">,</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;i love you&quot;</span>
<span class="p">})</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">_emit</span><span class="p">(</span><span class="s2">&quot;event-once&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">uid</span><span class="o">:</span> <span class="o">-</span><span class="mf">100</span><span class="p">,</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;you love me&quot;</span>
<span class="p">});</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">_emit</span><span class="p">(</span><span class="s2">&quot;event-once&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">uid</span><span class="o">:</span> <span class="o">-</span><span class="mf">100</span><span class="p">,</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;you love me&quot;</span>
<span class="p">});</span>

<span class="c1">// event-x 收到数据: {uid: 100, message: &quot;i love you&quot;}</span>
<span class="c1">// event-once 收到数据: {uid: -100, message: &quot;you love me&quot;}</span>
</code></pre></div>

<p>实际上，不仅仅是Window，任何继承了 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener">EventTarget</a>的对象，都具备这样的能力。</p>
<h3 id="passive">passive</h3>
<p>查看 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener#%E4%BD%BF%E7%94%A8_passive_%E6%94%B9%E5%96%84%E7%9A%84%E6%BB%9A%E5%B1%8F%E6%80%A7%E8%83%BD">使用 passive 改善的滚屏性能</a> 了解更多</p>
<h3 id="signal">signal</h3>
<p>这个signal是<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController">AbortController</a>的一部分，其主要作用是用来终止请求。</p>
<p>而在此处的作用，是用来移除监听器。    </p>
<p>如下的代码，如果注释<code>controller.abort();</code>, 就会收到两条消息。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AbortController</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">signal</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">signal</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">_dispatch</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">ev</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomEvent</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="p">{</span> <span class="nx">detail</span><span class="o">:</span> <span class="nx">data</span> <span class="p">});</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">ev</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;event-x&quot;</span><span class="p">,</span> <span class="nx">ev</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;event-x:收到数据：&quot;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">detail</span><span class="p">);</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">signal</span>
<span class="p">});</span>

<span class="nx">_dispatch</span><span class="p">(</span><span class="s2">&quot;event-x&quot;</span><span class="p">,</span> <span class="s2">&quot;i love you&quot;</span><span class="p">);</span>
<span class="c1">// 终止</span>
<span class="nx">controller</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
<span class="nx">_dispatch</span><span class="p">(</span><span class="s2">&quot;event-x&quot;</span><span class="p">,</span> <span class="s2">&quot;i love you&quot;</span><span class="p">);</span>

<span class="c1">// event-x:收到数据： i love you</span>
</code></pre></div>

<p>到此如果你真的全会，麻烦评论区评论 <code>一起围观作者</code>。</p>
<p><span id="__from"></span></p>
<h2 id="arrayfrom">Array.from</h2>
<div class="codehilite"><pre><span></span><code><span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">arrayLike</span><span class="p">[,</span> <span class="nx">mapFn</span><span class="p">[,</span> <span class="nx">thisArg</span><span class="p">]])</span>
</code></pre></div>

<p>重点是这个<code>mapFn</code>:</p>
<blockquote>
<p>apFn 可选
如果指定了该参数，新数组中的每个元素会执行该回调函数。</p>
</blockquote>
<p>先看妙用， 造一个1-100的数组，哦， so easy!</p>
<div class="codehilite"><pre><span></span><code>    <span class="nt">Array</span><span class="p">.</span><span class="nc">from</span><span class="o">(</span><span class="p">{</span><span class="n">length</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span><span class="o">,</span> <span class="o">(</span><span class="nt">val</span><span class="o">,</span> <span class="nt">index</span><span class="o">)=&gt;</span>  <span class="nt">index</span> <span class="o">+</span> <span class="nt">1</span> <span class="o">);</span>
</code></pre></div>

<p>字符串</p>
<div class="codehilite"><pre><span></span><code><span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span> 
<span class="c1">//  [ &quot;f&quot;, &quot;o&quot;, &quot;o&quot; ]</span>
</code></pre></div>

<p>Set </p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">([</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">]);</span>
<span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">set</span><span class="p">);</span>
<span class="c1">// [ &quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot; ]</span>
</code></pre></div>

<p>Map
这个地方大家看着可能有点迷，更多详情<a href="https://developer.mozilla.org/zh-CN/docs/orphaned/Web/JavaScript/Reference/Global_Objects/Map#map_%E4%B8%8E%E6%95%B0%E7%BB%84%E7%9A%84%E5%85%B3%E7%B3%BB">Map 与数组的关系</a></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([[</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">2</span><span class="p">,</span> <span class="mf">4</span><span class="p">],</span> <span class="p">[</span><span class="mf">4</span><span class="p">,</span> <span class="mf">8</span><span class="p">]]);</span>
<span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span> <span class="c1">// 等同于 [...map.entries()]</span>
<span class="c1">// [[1, 2], [2, 4], [4, 8]]</span>

<span class="kd">const</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]]);</span>
<span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">mapper</span><span class="p">.</span><span class="nx">values</span><span class="p">());</span>
<span class="c1">// [&#39;a&#39;, &#39;b&#39;];</span>

<span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">mapper</span><span class="p">.</span><span class="nx">keys</span><span class="p">());</span>
<span class="c1">// [&#39;1&#39;, &#39;2&#39;];</span>
</code></pre></div>

<p>序列生成器</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">range</span> <span class="o">=</span> <span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">stop</span><span class="p">,</span> <span class="nx">step</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span>
    <span class="p">{</span> <span class="nx">length</span><span class="o">:</span> <span class="p">(</span><span class="nx">stop</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="nx">step</span> <span class="o">+</span> <span class="mf">1</span><span class="p">},</span> 
    <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">start</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">step</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">// Generate numbers range 0..4</span>
<span class="nx">range</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="mf">4</span><span class="p">,</span> <span class="mf">1</span><span class="p">);</span>
<span class="c1">// [0, 1, 2, 3, 4]</span>
</code></pre></div>

<p>range在Python里面是自带的，你看我们JS的实现也很简单。</p>
<p><span id="__replace"></span></p>
<h2 id="stringreplace">String.replace</h2>
<blockquote>
<p>str.replace(regexp|substr, newSubStr|function)</p>
</blockquote>
<h3 id="_3">特殊变量名</h3>
<p><strong>特殊变量名</strong> 让这个<code>replace</code>属于化神后期, 下面的<code>$2, $1</code>就是字符串参数。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/(\w+)\s(\w+)/</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s2">&quot;John Smith&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">newstr</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="s2">&quot;$2, $1&quot;</span><span class="p">);</span>
<span class="c1">// Smith, John</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">newstr</span><span class="p">)</span>
</code></pre></div>

<p>所有的字符串参数如下：
| 变量名 | 代表的值 |
| --- | --- |
| $$ |插入一个 "$"  |
|$&amp;|插入匹配的子串。|
|$` |插入当前匹配的子串左边的内容。 |
| $'|插入当前匹配的子串右边的内容。 |
|$n | 假如第一个参数是 RegExp对象，并且 n 是个小于100的非负整数，那么插入第 n 个括号匹配的字符串。提示：索引是从1开始。如果不存在第 n个分组，那么将会把匹配到到内容替换为字面量。比如不存在第3个分组，就会用“$3”替换匹配到的内容。|
|$<Name>| 这里Name 是一个分组名称。如果在正则表达式中并不存在分组（或者没有匹配），这个变量将被处理为空字符串。只有在支持命名分组捕获的浏览器中才能使用|</p>
<h3 id="_4">第二个参数为函数</h3>
<p>为了方便理解，先看：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">replacer</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// p1 is nondigits, p2 digits, and p3 non-alphanumerics</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; - &#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">newString</span> <span class="o">=</span> <span class="s1">&#39;abc12345#$*%&#39;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^\d]*)(\d*)([^\w]*)/</span><span class="p">,</span> <span class="nx">replacer</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">newString</span><span class="p">);</span>  <span class="c1">// abc - 12345 - #$*%</span>
</code></pre></div>

<p>p1, p2, p3对应着 <strong>特殊变量名</strong> <code>$1, $2, $3</code>,  </p>
<p>更多的细节移步MDN <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/replace#%E6%8C%87%E5%AE%9A%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0">函数参数</a></p>
<h2 id="windowgetcomputestyle">window.getComputeStyle</h2>
<p>大家都知道，CSS有权重的说法，有style的，有css里面的各种，有浏览器的默认样式，等等。<br />
鬼知道，最后生效的是哪些样式。 鬼就等于这个<code>getComputeStyle</code>。 </p>
<p>先看个例子：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
 <span class="p">#</span><span class="nn">elem-container</span><span class="p">{</span>
   <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
   <span class="k">left</span><span class="p">:</span>     <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
   <span class="k">top</span><span class="p">:</span>      <span class="mi">200</span><span class="kt">px</span><span class="p">;</span>
   <span class="k">height</span><span class="p">:</span>   <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
   <span class="k">z-index</span><span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
 <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;elem-container&quot;</span><span class="p">&gt;</span>dummy<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span> 
    <span class="kd">let</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;elem-container&quot;</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">ps</span> <span class="o">=</span>  <span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ps</span><span class="p">..</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">));</span> <span class="c1">// 100px</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<h3 id="_5">读值方式</h3>
<ol>
<li>ps.getPropertyValue("z-index");</li>
<li>ps["z-index"];</li>
<li>ps.zIndex （同style的读取）</li>
</ol>
<p>上面的三种方式都是可行的。</p>
<h3 id="_6">返回值为解析值</h3>
<p>getComputedStyle的返回值是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/resolved_value">解析值</a>, 常跟CSS2.1中的<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/computed_value">计算值</a>是相同的值。 但对于一些旧的属性，比如width, height, padding 它们的值又为 <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/used_value">应用值</a>。</p>
<p><strong>计算值</strong>： 例如，如一个元素的属性值为 font-size:16px 和 padding-top:2em, 则 padding-top 的计算值为 32px (字体大小的2倍)。 <br />
<strong>应用值</strong>： 比如：span 指定 position: absolute 后display 变为 block。</p>
<p>其次值和设置的值不一定是同样的格式， <br />
比如你设置的 color的值是 red，返回的值是 <code>rgb(255, 0, 0)</code>; <br />
比如你说的 transform <code>transform: translate(10px, 10px)</code>,返回的值是 <code>matrix(1, 0, 0, 1, 10, 10)</code>。</p>
<h3 id="pseudoelt">第二个参数 pseudoElt</h3>
<blockquote>
<p>pseudoElt 可选 <br />
指定一个要匹配的伪元素的字符串。必须对普通元素省略（或null）</p>
</blockquote>
<p>就是用来获取<a href="https://drafts.csswg.org/css-content-3/#pseudo-elements">伪元素</a>的最终样式, 常见的有 ::after, ::before, ::marker, ::line-marker。</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
    <span class="nt">h3</span><span class="p">::</span><span class="nd">after</span> <span class="p">{</span>
        <span class="k">content</span><span class="p">:</span> <span class="s2">&quot;rocks!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>generated content<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="kd">let</span> <span class="nx">h3</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">),</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">h3</span><span class="p">,</span> <span class="s1">&#39;::after&#39;</span><span class="p">).</span><span class="nx">content</span><span class="p">;</span>
    <span class="nx">alert</span><span class="p">(</span><span class="sb">`the generated content is: </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`the generated content is: </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="c1">// the generated content is: &quot;rocks!&quot;</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>写在最后，<code>getComputeStyle</code>会触发重排，当然很多获取宽高的都会触发重排。心里有这个概念就行。</p>
<h2 id="localstorage-sessionstorage">localStorage &amp;&amp; sessionStorage</h2>
<h3 id="storage">storage事件</h3>
<p>这里要说的是<code>localStorage.setItem</code>，其本身没有什么好说的。
与其对应的有一个<a href="StorageEvent"><code>storage事件</code></a>，其可以监听storage的值的变化。 </p>
<p>A.html</p>
<div class="codehilite"><pre><span></span><code>localStorage.setItem(&quot;data&quot;, JSON.stringify({
    a: 1,
    b: 3
}))
</code></pre></div>

<p>B.html</p>
<div class="codehilite"><pre><span></span><code><span class="nt">window</span><span class="p">.</span><span class="nc">addEventListener</span><span class="o">(</span><span class="s2">&quot;storage&quot;</span><span class="o">,</span> <span class="o">(</span><span class="nt">ev</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="err">console.log(&quot;</span><span class="n">key</span><span class="p">:</span><span class="s2">&quot;, ev.key);   // key: data</span>
<span class="s2">    console.log(&quot;</span><span class="n">oldValue</span><span class="o">:</span><span class="s2">&quot;, ev.oldValue); // oldValue: null</span>
<span class="s2">    console.log(&quot;</span><span class="n">newValue</span><span class="o">:</span><span class="s2">&quot;, ev.newValue);  // newValue: {&quot;</span><span class="n">a</span><span class="s2">&quot;:1,&quot;</span><span class="n">b</span><span class="s2">&quot;:3}</span>
<span class="s2">    console.log(&quot;</span><span class="n">storageArea</span><span class="o">:</span><span class="s2">&quot;, ev.storageArea); </span>
<span class="s2">    // storageArea: Storage {ev: &quot;</span><span class="err">{\</span><span class="s2">&quot;a\&quot;:1,\&quot;b\&quot;:3}&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="nt">console</span><span class="p">.</span><span class="nc">log</span><span class="o">(</span><span class="s2">&quot;url:&quot;</span><span class="o">,</span> <span class="nt">ev</span><span class="p">.</span><span class="nc">url</span><span class="o">);</span> <span class="o">//</span> <span class="nt">url</span><span class="o">:</span> <span class="nt">http</span><span class="o">://</span><span class="nt">127</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">1</span><span class="p">:</span><span class="nd">8080</span><span class="o">/</span><span class="nt">A</span><span class="p">.</span><span class="nc">html</span>
<span class="err">}</span><span class="o">);</span>
</code></pre></div>

<p>从上面隐藏两个细节
1. A.html调用setItem, B.html监听事件
因为A.html自身是监听不到这个事件的   </p>
<ol>
<li>storage事件对象上有oldValue喝newValue属性
可以得出，设置同样的值，不会触发事件。 </li>
</ol>
<h3 id="setitemstorage">让setItem的页面监听storage事件</h3>
<p>原理，重写setItem事件</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nx">originalSetItem</span> <span class="o">=</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">;</span>
<span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">itemEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomEvent</span><span class="p">(</span><span class="s2">&quot;c-storage&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">detail</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">oldValue</span><span class="o">:</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span>
            <span class="nx">newValue</span><span class="p">,</span>
            <span class="nx">key</span><span class="p">,</span>
            <span class="nx">url</span><span class="o">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">href</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">itemEvent</span><span class="p">);</span>
    <span class="nx">originalSetItem</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;c-storage&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ev&quot;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">detail</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// key: &quot;data&quot;</span>
<span class="c1">// newValue: 1624506604683</span>
<span class="c1">// oldValue: &quot;1624506595323&quot;</span>
<span class="c1">// url: &quot;http://127.0.0.1:8080/LA.html&quot;</span>

<span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
</code></pre></div>

<p>IE貌似有bug，<a href="https://juejin.cn/post/6883719958337945607">同页面 Storage 变化监听</a>有提到</p>
<h2 id="_7">控制台特有的</h2>
<h3 id="console">console系列</h3>
<p>那些 <code>console.table</code>, <code>console.time</code>, <code>console.assert0</code>, <code>console.count</code>, <code>console.group</code>我就不说了。   </p>
<p>偏偏说一下<code>console.log</code> <br />
console.log定义样式：来源<a href="https://juejin.cn/post/6844903725908099079">多彩的 console.log</a></p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span> <span class="mf">1.</span> <span class="err">将</span><span class="n">css样式内容放入数组</span>
<span class="k">const</span> <span class="n">styles</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">&#39;color: green&#39;</span><span class="p">,</span> 
  <span class="s1">&#39;background: yellow&#39;</span><span class="p">,</span> 
  <span class="s1">&#39;font-size: 30px&#39;</span><span class="p">,</span>
  <span class="s1">&#39;border: 1px solid red&#39;</span><span class="p">,</span>
  <span class="s1">&#39;text-shadow: 2px 2px black&#39;</span><span class="p">,</span>
  <span class="s1">&#39;padding: 10px&#39;</span><span class="p">,</span>
<span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">);</span> 
<span class="o">//</span> <span class="mf">2.</span> <span class="err">利用</span><span class="n">join方法讲各项以分号连接成一串字符串</span>
<span class="o">//</span> <span class="mf">3.</span> <span class="err">传入</span><span class="n">styles变量</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%c</span><span class="s1">Hello There&#39;</span><span class="p">,</span> <span class="n">styles</span><span class="p">);</span>
</code></pre></div>

<p>输出：
<img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/35316f72fa7e4d159cae9261e4f08ca8~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_8">符号函数系列</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$_</td>
<td>最后一个评估值</td>
</tr>
<tr>
<td>$(selector)</td>
<td>document.querySelector</td>
</tr>
<tr>
<td>?(selector)</td>
<td>document.querySelectorAll</td>
</tr>
<tr>
<td>$x(path)</td>
<td>XPathEvaluator</td>
</tr>
</tbody>
</table>
<div class="codehilite"><pre><span></span><code><span class="nx">$x</span><span class="p">(</span><span class="s2">&quot;/html/body&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="image.png" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f205f06210f404ca1ed5f4d8bd47516~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_9">其他</h3>
<p><code>getEventListeners</code>: <br />
你有没有碰到过，想查询某个元素的所有监听函数的需求，在页面里面是没有这种功能。
但是控制台是有的
看图</p>
<p><img alt="image.png" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ac345831a9b4c4f9d6cfd90b6df6369~tplv-k3u1fbpfcp-watermark.image" /></p>
<p><code>clear</code>:
清空控制台</p>
<h2 id="_10">写在最后</h2>
<p><strong>写作不易，一赞一评，就是我最大的动力。</strong></p>
<blockquote>
<p><a href="https://juejin.cn/post/6883719958337945607">同页面 Storage 变化监听</a> <br />
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout">setTimeout</a> <br />
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval">setInterval</a>  <br />
<a href="https://developer.mozilla.org/zh-CN/docs/orphaned/Web/JavaScript/Reference/Global_Objects/Map#map_%E4%B8%8E%E6%95%B0%E7%BB%84%E7%9A%84%E5%85%B3%E7%B3%BB">Map 与数组的关系</a> <br />
<a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers">timers-and-user-prompts</a> <br />
<a href="https://juejin.cn/post/6844903725908099079">多彩的console.log</a> <br />
<a href="https://juejin.cn/post/6844904007102627847">推荐几个不错的console调试技巧</a></p>
</blockquote><h1>这16种原生函数和属性的区别，你真的知道吗？ 精心收集，高级前端必备知识，快快打包带走</h1><p>本文已参与好文召集令活动，点击查看：<a href="https://juejin.cn/post/6978685539985653767">后端、大前端双赛道投稿，2万元奖池等你挑战！</a></p>
<h2 id="_1">前言</h2>
<p>原生内置了很多API, 作用类似，却也有差千差万别，了解其区别，掌握前端基础，是修炼上层，成为前端高级工程师的必备知识，让我们一起来分类归纳，一起成长吧。</p>
<p>上一篇前端基础好文： <a href="https://juejin.cn/post/6977239278145241101">那些你熟悉而又陌生的函数</a></p>
<h2 id="keys-getownpropertynames-getownpropertysymbols">属性获取 <code>keys</code>, <code>getOwnPropertyNames</code>, <code>getOwnPropertySymbols</code></h2>
<h3 id="objectkeys"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/keys">Object.keys</a></h3>
<p>返回一个由一个给定对象的自身<strong>可枚举属性</strong>组成的数组，数组中属性名的排列顺序和正常循环遍历该对象时返回的顺序一致 。</p>
<h3 id="objectgetownpropertynames"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames">Object.getOwnPropertyNames</a></h3>
<p>返回一个由指定对象的所有自身属性的属性名（<strong>包括不可枚举属性但不包括Symbol值作为名称的属性</strong>）组成的数组。</p>
<h3 id="objectgetownpropertysymbols"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertySymbols">Object.getOwnPropertySymbols</a></h3>
<p>一个给定对象自身的所有 Symbol 属性的数组。</p>
<h3 id="reflectownkeys"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect/ownKeys">Reflect.ownKeys</a></h3>
<p>返回一个由目标对象自身的属性键组成的数组。 <br />
 等同于Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))</p>
<p>### 例子
 ```js
const symbolSalary = Symbol.for("salary");
const symbolIsAnimal = Symbol.for("isAnimal");
const symbolSay = Symbol.for("say");</p>
<p>function Person(age, name){
    this.age = age;
    this.name = name;</p>
<div class="codehilite"><pre><span></span><code><span class="nt">this</span><span class="p">.</span><span class="nc">walk</span> <span class="o">=</span> <span class="nt">function</span> <span class="o">()</span> <span class="p">{</span>
    <span class="err">console.log(&quot;</span><span class="n">person</span><span class="p">:</span><span class="n">walk</span><span class="err">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>}</p>
<p>// 原型方法
Person.prototype.say = function(words){
    console.log("say:", words);
}
Person.prototype[symbolSay] = function(words){
    console.log("symbolSay", words);
}</p>
<p>// 原型属性
Person.prototype[symbolIsAnimal] = true;
Person.prototype.isAnimal = true;</p>
<p>const person = new Person(100, "程序员");</p>
<p>person[symbolSalary] = 6000;
person["sex"] = "男";</p>
<p>// sex 不可枚举
Object.defineProperty(person, "sex", {
    enumerable: false
});</p>
<p>Object.defineProperty(person, symbolSalary, {
    enumerable: false, // 无效的设置 
    value: 999
});</p>
<p>const keys = Object.keys(person);
const names = Object.getOwnPropertyNames(person);
const symbols = Object.getOwnPropertySymbols(person);
const ownKeys = Reflect.ownKeys(person);</p>
<p>console.log("keys", keys);  // [ 'age', 'name', 'walk' ]
console.log("getOwnPropertyNames", names); // [ 'age', 'name', 'walk', 'sex' ]
console.log("getOwnPropertySymbols", symbolSalary); // [ Symbol(salary) ]
console.log("ownKeys", ownKeys); // [ 'age', 'name', 'walk', 'sex', Symbol(salary) ]</p>
<p>console.log("--------")
console.log(person.isAnimal);  // true
console.log(person[symbolIsAnimal]); // true
console.log(person[symbolSalary]);  // 999
person<a href="" title="hello world">symbolSay</a>; // symbolSay hello world
person.say("hello world"); // say: hello world
person.walk(); // person:walk
 ```</p>
<h3 id="_2">总结</h3>
<ol>
<li>
<p>Object.keys：则返回的是所有可枚举属性键，也就是属性下的enumerable: true。但不包括Symbol值作为名称的属性键。</p>
</li>
<li>
<p>Object.getOwnPropertyNames：返回的是对象所有自己的属性键 ，包括不可枚举属性但不包括Symbol值作为名称的属性键。</p>
</li>
<li>
<p>Object.getOwnPropertySymbols: 方法返回一个给定对象自身的所有 Symbol 属性键的数组。</p>
</li>
<li>
<p>Reflect.ownKeys: 返回一个由目标对象自身的属性键组成的数组。等同于Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))。</p>
</li>
</ol>
<h2 id="nodecontains-nodecomparedocumentposition">节点位置关系 <code>Node.contains</code>, <code>Node.compareDocumentPosition</code></h2>
<h3 id="nodecomparedocumentposition"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Node/compareDocumentPosition">Node.compareDocumentPosition</a></h3>
<p>比较当前节点与任意文档中的另一个节点的位置关系</p>
<p>语法 <code>compareMask = node.compareDocumentPosition( otherNode )</code>  </p>
<p>返回值是一个具有以下值的位掩码：
| 常量名 | 十进制值 | 含义 |
| --- | --- |--- |
| DOCUMENT_POSITION_DISCONNECTED | 1  | 不在同一文档中|
| DOCUMENT_POSITION_PRECEDING | 2 |otherNode在node之前 |
| DOCUMENT_POSITION_FOLLOWING | 4 |otherNode在node之后 |
| DOCUMENT_POSITION_CONTAINS | 8 |otherNode包含node |
| DOCUMENT_POSITION_CONTAINED_BY | 16 |otherNode被node包含 |
| DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC | 32 |待定 |</p>
<p>在一些场景下，可能设置了不止一位比特值。比如 otherNode 在文档中是靠前的且包含了 Node, 那么DOCUMENT_POSITION_CONTAINS 和 DOCUMENT_POSITION_PRECEDING 位都会设置，所以结果会是 0x0A 即十进制下的 10。</p>
<p>看代码： <br />
结果是： <code>20</code><br />
1. child 在 parent之后，赋值得4
2. child 被 parent包含，赋值的16</p>
<p><code>4 + 16 = 20</code></p>
<div class="codehilite"><pre><span></span><code>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;parent&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;child&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>

        <span class="kd">const</span> <span class="nx">pEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">cEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;child&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pEl</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">(</span><span class="nx">cEl</span><span class="p">));</span>  <span class="c1">// 20</span>

    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<h3 id="nodecontains"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Node/contains">Node.contains</a></h3>
<p>返回的是一个布尔值，来表示传入的节点是否为该节点的后代节点</p>
<p>基本等于compareDocumentPosition的 <code>| DOCUMENT_POSITION_CONTAINED_BY | 16 |otherNode被node包含 |</code></p>
<h3 id="_3">总结</h3>
<ol>
<li>compareDocumentPosition 返回的是数字，带组合意义的数据，不仅仅可以返回包含，还可以返回在之前之后等信息</li>
<li>contains 返回的是布尔值，仅仅告诉你是否有包含关系</li>
</ol>
<h2 id="innertext-textcontent">取文本 <code>innerText</code>, <code>textContent</code></h2>
<h3 id="htmlelementinnertext"><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/innerText">HTMLElement.innerText</a></h3>
<p>解析过程：
1. 对HTML标签进行解析；
2. 对CSS样式进行带限制的解析和渲染；
3. 将ASCII实体转换为对应的字符；
4. <strong>剔除格式信息（如\t、\r、\n等），将多个连续的空格合并为一个</strong></p>
<h3 id="nodetextcontent"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/textContent">Node.textContent</a></h3>
<p>解析过程：
 1. 对HTML标签进行<strong>剔除</strong>； 
 2. 将ASCII实体转换为相应的字符。<br />
 需要注意的是：</p>
<ol>
<li><strong>对HTML标签是剔除不是解析，也不会出现CSS解析和渲染的处理，因此<code>&lt;br/&gt;</code>等元素是不生效的。</strong>  </li>
<li><strong>不会剔除格式信息和合并连续的空格，因此\t、\r、\n和连续的空格将生效</strong></li>
</ol>
<h3 id="_4">例子</h3>
<div class="codehilite"><pre><span></span><code>    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;source&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
            <span class="p">#</span><span class="nn">source</span> <span class="p">{</span>
                <span class="k">color</span><span class="p">:</span> <span class="kc">red</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
        Take a look at<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>how this text<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>is interpreted
        below.
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display:none&quot;</span><span class="p">&gt;</span>HIDDEN TEXT<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

     <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Result of textContent:<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;textContentOutput&quot;</span> <span class="na">rows</span><span class="o">=</span><span class="s">&quot;12&quot;</span> <span class="na">cols</span><span class="o">=</span><span class="s">&quot;50&quot;</span> <span class="na">readonly</span><span class="p">&gt;</span>...<span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Result of innerText:<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;innerTextOutput&quot;</span> <span class="na">rows</span><span class="o">=</span><span class="s">&quot;12&quot;</span> <span class="na">cols</span><span class="o">=</span><span class="s">&quot;50&quot;</span> <span class="na">readonly</span><span class="p">&gt;</span>...<span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">textContentOutput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;textContentOutput&#39;</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">innerTextOutput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;innerTextOutput&#39;</span><span class="p">);</span>

        <span class="nx">textContentOutput</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">textContent</span><span class="p">;</span>
        <span class="nx">innerTextOutput</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">innerText</span><span class="p">;</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>看看结果：</p>
<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e76205751a94d4c909c18107788d809~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_5">总结</h3>
<ol>
<li>innerText是会解析css的，<code>&lt;br/&gt;</code>有效，剔除格式信息（如\t、\r、\n等），将多个连续的空格合并为一个。</li>
<li>textContent是剔除html标签，<code>&lt;br/&gt;</code>无效，<code>\t、\r、\n</code>和连续的空格将生效。</li>
</ol>
<h2 id="value-nodevalue">节点取值 <code>value</code> ,  <code>nodeValue</code></h2>
<h3 id="nodenodevalue"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Node/nodeValue">Node.nodeValue</a></h3>
<ul>
<li>对于<code>text</code>, <code>comment</code>, 和 <code>CDATA</code> 节点来说, nodeValue返回该节点的文本内容.    </li>
<li>对于 <strong>attribute</strong> 节点来说, 返回该属性的属性值.</li>
</ul>
<p>对应着下面表格的 nodeType的值 text <code>3</code>,<code>4</code>,<code>8</code></p>
<table>
<thead>
<tr>
<th>常量</th>
<th>nodeType 值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node.ELEMENT_NODE</td>
<td>1</td>
<td>一个 元素 节点，例如 <p> 和 <div></td>
</tr>
<tr>
<td>Node.TEXT_NODE</td>
<td>3</td>
<td>Element 或者 Attr 中实际的  文字</td>
</tr>
<tr>
<td>Node.CDATA_SECTION_NODE</td>
<td>4</td>
<td>一个 CDATASection，例如 \&lt;!CDATA[[ … ]]>。</td>
</tr>
<tr>
<td>Node.PROCESSING_INSTRUCTION_NODE</td>
<td>7</td>
<td>一个用于XML文档的  ProcessingInstruction (en-US) ，例如 &lt;?xml-stylesheet ... ?&gt; 声明。</td>
</tr>
<tr>
<td>Node.COMMENT_NODE</td>
<td>8</td>
<td>一个 Comment 节点。</td>
</tr>
<tr>
<td>Node.DOCUMENT_NODE</td>
<td>9</td>
<td>一个 Document 节点。</td>
</tr>
<tr>
<td>Node.DOCUMENT_TYPE_NODE</td>
<td>10</td>
<td>描述文档类型的 DocumentType 节点。例如 &lt;!DOCTYPE html&gt;  就是用于 HTML5 的。</td>
</tr>
<tr>
<td>Node.DOCUMENT_FRAGMENT_NODE</td>
<td>11</td>
<td>一个 DocumentFragment 节点</td>
</tr>
</tbody>
</table>
<h3 id="value">value</h3>
<p>特定的一些HTMLElement元素，用value属性获取其值。常见的有value属性的元素如下：
   * <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLInputElement">HTMLInputElement</a>  <code>&lt;input value="1" /&gt;</code>
   * <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLTextAreaElement">HTMLTextAreaElement</a> <code>&lt;textarea value= "你哈" /&gt;</code>
   * <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLButtonElement">HTMLButtonElement</a> <code>&lt;button value= "提交" /&gt;</code>
   * <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLDataElement">HTMLDataElement</a>   <code>&lt;data value="21053"&gt;圣女果&lt;/data&gt;</code>
   * <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLSelectElement">HTMLSelectElement</a> <code>&lt;select&gt;&lt;option value ="volvo"&gt;Volvo&lt;/option&gt;</code>
   * <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLOptionElement">HTMLOptionElement</a>  <code>&lt;select&gt;&lt;option value ="volvo"&gt;Volvo&lt;/option&gt;</code><br />
   * <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLParamElement">HTMLParamElement</a>  </p>
<p>```js
<br />
<object classid="clsid:F08DF954-8592-11D1-B16A-00C0F0283628" id="Slider1" width="100" height="50">    
       <param name="BorderStyle" value="1" />
  </object></p>
<p>```</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLProgressElement">HTMLProgressElement</a>  <code>&lt;progress value="22" max="100"&gt;&lt;/progress&gt;</code></li>
</ul>
<p>### 总结</p>
<ol>
<li>nodeValue 是文本节点，属性节点，注释节点等类型的节点用来取值的方法</li>
<li>vlaue是特定的<strong>元素节点</strong>用来取值的方法</li>
</ol>
<h2 id="adoptnode-importnode-clonenode">节点复制 <code>adoptNode</code>, <code>importNode</code>, <code>cloneNode</code></h2>
<h3 id="documentadoptnode"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/adoptNode">Document.adoptNode</a></h3>
<p>将外部文档的一个<strong>节点拷贝一份</strong>,然后可以把这个拷贝的节点插入到当前文档中.</p>
<h3 id="documentimportnode"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/importNode">Document.importNode</a></h3>
<p>从其他的document文档中获取一个节点。 该节点以及它的子树上的所有节点都会从<strong>原文档删除</strong> , 并且它的ownerDocument 属性会变成当前的document文档。 之后你可以把这个节点插入到当前文档中。</p>
<h3 id="nodeclonenode"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/cloneNode">Node.cloneNode</a></h3>
<p>生成节点的一个副本。</p>
<p>实际上 <code>Document</code> 是继承自 <code>Node</code>， 也具备<code>cloneNode</code>方法。
<img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/359e6911dd46455aa1ea7d4914864e90~tplv-k3u1fbpfcp-watermark.image" /></p>
<p>这里提一个问题：<br />
<code>Document.adoptNode</code>与<code>Document.importNode</code>是操作外部文档的，那么操作所在的文档会有什么效果呢？</p>
<p><code>Node.cloneNode</code> 有一个<code>boolean</code>类型的可选参数<code>deep</code>： <br />
* <code>true</code>:  则该节点的所有后代节点也都会被克隆
* <code>false</code>:  则只克隆该节点本身.  </p>
<p><strong>注意</strong><br />
1. cloneNode <code>deep</code>参数在不同版本的浏览器实现中，<strong>默认值可能不一样</strong>， 所以强烈建议写上值。
2. cloneNode 会克隆一个元素节点会拷贝它所有的属性以及属性值,当然也就包括了<strong>属性上绑定的事件(比如onclick="alert(1)"),但不会拷贝那些使用addEventListener()方法或者node.onclick = fn这种用JavaScript动态绑定的事件</strong></p>
<h3 id="_6">总结</h3>
<ol>
<li>adoptNode 从外部文档进行拷贝</li>
<li>importNode 从外部文档进行拷贝，并从外部文档删除</li>
<li>cloneNode 从本文档进行复制，有浅复制和深复制</li>
</ol>
<h2 id="childnodes-children">父节点 <code>childNodes</code> , <code>children</code></h2>
<h3 id="nodechildnodes"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Node/childNodes">Node.childNodes</a></h3>
<p>节点的子节点集合，包括元素节点、文本节点还有属性节点</p>
<h3 id="parentnodechildren"><a href="https://developer.mozilla.org/zh-CN/docs/orphaned/Web/API/ParentNode/children">ParentNode.children</a></h3>
<p>返回的只是节点的元素节点集合, 即 <code>nodeType</code>为1的节点。</p>
<h3 id="_7">例子</h3>
<p>来实际看一段代码：</p>
<div class="codehilite"><pre><span></span><code>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">&gt;</span>
        1
        <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        3
        <span class="c">&lt;!-- &lt;div&gt;&lt;/div&gt; --&gt;</span>
        <span class="cp">&lt;!CDATA[[ 4 ]]&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="kd">const</span> <span class="nx">rootEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rootEl</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rootEl</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">);</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>返回结果截图： 
<img alt="image.png" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4aec574eee4749c5bb04b6c7f2be812e~tplv-k3u1fbpfcp-watermark.image" /></p>
<p><code>Node.parentNode</code>与<code>Node.parentElement</code>也是同样的道理。</p>
<h3 id="_8">总结</h3>
<ol>
<li>children只返回元素节点，也就是 nodeType为1的节点</li>
<li>childNodes 返回所有类型的节点</li>
</ol>
<h2 id="append-appendchild">添加节点 <code>append</code>, <code>appendChild</code></h2>
<h3 id="nodeappendchild"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Node/appendChild">node.appendChild</a></h3>
<p>将一个节点附加到指定父节点的子节点列表的末尾处</p>
<h3 id="parentnodeappend"><a href="https://developer.mozilla.org/zh-CN/docs/orphaned/Web/API/ParentNode/append">ParentNode.append</a></h3>
<p>方法在 ParentNode的最后一个子节点之后插入一组 Node 对象或 DOMString 对象。
被插入的 DOMString 对象等价为 Text 节点.</p>
<h3 id="_9">例子</h3>
<p>我们一次append三个节点，其中两个文本节点，一个div节点。</p>
<div class="codehilite"><pre><span></span><code>  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="kd">function</span> <span class="nx">createEl</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">innerHTML</span><span class="p">){</span>
        <span class="kd">const</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">innerHTML</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">el</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">rootEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">);</span>

    <span class="nx">rootEl</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;我们&quot;</span><span class="p">,</span> <span class="nx">createEl</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="s2">&quot;都是&quot;</span><span class="p">),</span> <span class="s2">&quot;好孩子&quot;</span><span class="p">);</span>
  <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ab7efa388f349adb51eea288747d16b~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_10">总结</h3>
<ul>
<li>ParentNode.append()允许追加  DOMString 对象，而 Node.appendChild() 只接受 Node 对象。</li>
<li>ParentNode.append() 没有返回值，而 Node.appendChild() 返回追加的 Node 对象。</li>
<li>ParentNode.append() 可以追加多个节点和字符串，而 Node.appendChild() 只能追加一个节点。</li>
</ul>
<p>简直说， append强大太多了。</p>
<h2 id="documenthidden-documentvisibilitystate">文档可见状态 <code>Document.hidden</code>, <code>Document.visibilityState</code></h2>
<h3 id="documenthidden"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/hidden">document.hidden</a></h3>
<p>返回布尔值，表示页面是（true）否（false）隐藏。</p>
<h3 id="documentvisibilitystate"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilityState">Document.visibilityState</a></h3>
<p>返回document的可见性, 由此可以知道当前文档(即为页面)是在背后, 或是不可见的隐藏的标签页，或者(正在)预渲染.可用的值如下：
* 'visible' : 此时页面内容至少是部分可见. 即此页面在前景标签页中，并且窗口没有最小化.
* 'hidden' : 此时页面对用户不可见. 即文档处于背景标签页或者窗口处于最小化状态，或者操作系统正处于 '锁屏状态' .
* 'prerender' : 页面此时正在渲染中, 因此是不可见的 . 文档只能从此状态开始，永远不能从其他值变为此状态 .注意: 浏览器支持是可选的.</p>
<p>当此属性的值改变时, 会递交 <code>visibilitychange</code> 事件给Document.</p>
<h3 id="_11">例子</h3>
<p>我们先输出当前状态，然后点击别的tab,等下再点击回来。</p>
<div class="codehilite"><pre><span></span><code>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
        <span class="s2">&quot;visibilityState:&quot;</span><span class="p">,</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">visibilityState</span><span class="p">,</span>
        <span class="s2">&quot; hidden:&quot;</span><span class="p">,</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">hidden</span><span class="p">,</span>
      <span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;visibilitychange&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
          <span class="s2">&quot;visibilityState:&quot;</span><span class="p">,</span>
          <span class="nb">document</span><span class="p">.</span><span class="nx">visibilityState</span><span class="p">,</span>
          <span class="s2">&quot; hidden:&quot;</span><span class="p">,</span>
          <span class="nb">document</span><span class="p">.</span><span class="nx">hidden</span>
        <span class="p">);</span>
      <span class="p">});</span>
</code></pre></div>

<p><img alt="image.png" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/345deaddf57243bbb8af3238240f4159~tplv-k3u1fbpfcp-watermark.image" /></p>
<p>我们日常可以用<code>visibilitychange</code>来监听当前页面处于隐藏时，去清除定时器或页面中的动画, 停止音乐视频等的播放。</p>
<p>我还想到一个有意思的
1. 广告倒计时
你离开后，不算倒计时，会不会被骂死</p>
<ol>
<li>阅读某些协议
你离开后，停止倒计时</li>
</ol>
<h3 id="_12">总结</h3>
<ol>
<li>hidden 与 visibilityState 返回值不同，一个是布尔值，一个是字符串</li>
<li>visibilityState 的状态多一种 <code>prerender</code>, 其对应的hidden的值是true</li>
<li>visibilityState e有相关的事件</li>
</ol>
<h2 id="call-apply-bind">函数调用 <code>call</code>, <code>apply</code>, <code>bind</code></h2>
<h3 id="functionprototypecall"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/call">Function.prototype.call</a></h3>
<p>使用一个指定的 this 值和单独给出的一个或多个参数来调用一个函数</p>
<h3 id="functionprototypeapply"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/apply">Function.prototype.apply</a></h3>
<p>调用一个具有给定this值的函数，以及以一个数组（或类数组对象）的形式提供的参数</p>
<h3 id="functionprototypebind"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/bind">Function.prototype.bind</a></h3>
<p>方法创建一个新的函数，在 bind() 被调用时，这个新函数的 this 被指定为 bind() 的第一个参数，而其余参数将作为新函数的参数，供调用时使用</p>
<h3 id="_13">例子</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">sum</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">s</span><span class="p">,</span> <span class="nx">cur</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">s</span> <span class="o">+</span> <span class="nx">cur</span><span class="p">;</span>
    <span class="p">},</span> <span class="mf">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span> <span class="o">||</span> <span class="mf">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">base</span><span class="o">:</span> <span class="mf">1000</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">bindFun</span> <span class="o">=</span> <span class="nx">sum</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">callResult</span> <span class="o">=</span> <span class="nx">sum</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="mf">4</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">applyResult</span> <span class="o">=</span> <span class="nx">sum</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="mf">4</span><span class="p">]);</span>
<span class="kd">const</span> <span class="nx">bindResult</span> <span class="o">=</span> <span class="nx">bindFun</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span> <span class="mf">4</span><span class="p">);</span>


<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;call:&quot;</span><span class="p">,</span> <span class="nx">callResult</span><span class="p">);</span>  <span class="c1">// 1010</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;apply:&quot;</span><span class="p">,</span> <span class="nx">applyResult</span><span class="p">);</span> <span class="c1">// 1010 </span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;bind:&quot;</span><span class="p">,</span> <span class="nx">bindResult</span><span class="p">);</span> <span class="c1">// 1010</span>
</code></pre></div>

<h3 id="_14">总结</h3>
<p>相同点，都能改变被调用函数的this指向。</p>
<ol>
<li>call: 第二个参数开始，可以接收任意个参数</li>
<li>apply: 第二个参数，必须是数组或者类数组</li>
<li>bind:  第二个参数开始，可以接收任意个参数 , <strong>返回的是一个新的函数</strong></li>
</ol>
<p>注意点：
1. bind调用多次，this指向第一次第一个参数</p>
<p>log 调用了两次bind, 第一次bind<code>{ val: 1 }</code>, 第二次bind<code>{ val: 2 }</code>, 输出的this是一次bind的上下文</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">log</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;this&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">({</span> <span class="nx">val</span><span class="o">:</span> <span class="mf">1</span> <span class="p">}).</span><span class="nx">bind</span><span class="p">({</span> <span class="nx">val</span><span class="o">:</span> <span class="mf">2</span> <span class="p">})())</span>  <span class="c1">// { val: 1 }</span>
</code></pre></div>

<p>再看一段类似的代码：<br />
虽然this的指向不会再变改变，但是参数还是继续接受， arguments 长度为2，
第一次bind的1，第二次bind的 2 , 都照单全收。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">log</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;this&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>   <span class="c1">// { val: 1 }</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>  <span class="c1">// { &#39;0&#39;: 1, &#39;1&#39;: 2 }</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">({</span> <span class="nx">val</span><span class="o">:</span> <span class="mf">1</span> <span class="p">},</span> <span class="mf">1</span><span class="p">).</span><span class="nx">bind</span><span class="p">({</span> <span class="nx">val</span><span class="o">:</span> <span class="mf">2</span> <span class="p">},</span> <span class="mf">2</span><span class="p">)())</span>  <span class="c1">// 1</span>
</code></pre></div>

<h2 id="substr-substring">字符串截取 <code>substr</code>, <code>substring</code></h2>
<h3 id="stringprototypesubstr"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/substr">String.prototype.substr</a></h3>
<p>返回一个字符串中从指定位置开始到<strong>指定字符数</strong>的字符</p>
<p>语法： 
第二参数，<strong>是需要截取的长度</strong></p>
<blockquote>
<p>str.substr(start[, length])</p>
</blockquote>
<h3 id="stringprototypesubstring"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/substring">String.prototype.substring</a></h3>
<p>返回一个字符串在开始索引到结束索引之间的一个子集, 或从开始索引直到字符串的末尾的一个子集。</p>
<p>语法：
第二参数，<strong>结束索引</strong></p>
<blockquote>
<p>str.substring(indexStart[, indexEnd])</p>
</blockquote>
<h3 id="_15">例子</h3>
<p>提示：
1. 两个参数都没设置的时候，效果相同
2. 第一个参数是<strong>大于等于0的整数</strong>，没设置第二参数的时候，效果相同</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">str</span> <span class="o">=</span> <span class="s2">&quot;我们都是好孩子&quot;</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substr</span><span class="p">())</span>  <span class="c1">// 我们都是好孩子</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">())</span> <span class="c1">// 我们都是好孩子</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mf">1</span><span class="p">))</span>  <span class="c1">// 们都是好孩子</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">1</span><span class="p">))</span> <span class="c1">// 们都是好孩子</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">))</span>  <span class="c1">// 子</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">))</span> <span class="c1">// 我们都是好孩子</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">))</span>  <span class="c1">// 们都</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">))</span>  <span class="c1">// 们</span>
</code></pre></div>

<h3 id="_16">总结</h3>
<ol>
<li>substr 第二个参数是需要截取的长度</li>
<li>substring 第二个参数是结束索引值的</li>
<li>没指定参数或者第一个参数是大于等于0的整数时，效果相同</li>
<li>第一个参数是负数或者第二个参数是负数，处理规则不通
具体参见 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/substr#description">substr</a>和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/substring#descriptio">substring</a></li>
</ol>
<h2 id="for-of-for-in">遍历 <code>for of</code>, <code>for in</code></h2>
<h3 id="for-in">for in</h3>
<p>获取<code>enumerable:true</code>的属性键</p>
<h3 id="for-of">for of</h3>
<p>遍历属性值。不受到<code>enumerable</code>限制。</p>
<h3 id="_17">例子</h3>
<ol>
<li>在数组原型上增加了方法<code>gogo</code>, <code>for in</code>结果中出现了，而 <code>for of</code>结果冲未出现。</li>
<li>定义了 属性2不能被遍历， <code>for in</code>结果中未出现，而 <code>for of</code>结果中出现了。</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 原型上增加方法</span>
<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gogo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;gogo&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">];</span>

<span class="c1">// key值2不可以枚举</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">});</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">});</span>

<span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">a</span><span class="p">){</span>
    <span class="c1">// 索引被遍历出来是字符串类型</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">p</span><span class="p">);</span> <span class="c1">// 0 string; 1 string; gogo string</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

<span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">a</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>  <span class="c1">// 1 2 3</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_18">总结</h3>
<p>for in
1. 获取enumerable:true的属性键。
2. 可以遍历对象。
3. 可以获取原型上的属性键。
4. 数字属性键被遍历出来是字符串。 比如索引值
for of：</p>
<ol>
<li>遍历属性值。不受到enumerable限制。</li>
<li>可遍历数组。 一般不可以遍历对象，如果实现了Symbol.iterator，可以遍历。 如Array，Map，Set，String，TypedArray，arguments 对象等等</li>
<li>不能获取原型上的值</li>
</ol>
<h2 id="datenow-performancenow">当前时间 <code>Date.now()</code>, <code>Performance.now()</code></h2>
<h3 id="datenow"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Date/now">Date.now()</a></h3>
<p>方法返回自 1970 年 1 月 1 日 00:00:00 (UTC) 到当前时间的毫秒数。</p>
<h3 id="performancenow"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/now">Performance.now</a></h3>
<p>获取当前的时间戳的值（自创建上下文以来经过的时间），其值是一个精确到毫秒的  <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp">DOMHighResTimeStamp</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">html</span> <span class="nx">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">,</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span>
    <span class="o">&lt;</span><span class="err">/script&gt;</span>
<span class="o">&lt;</span><span class="err">/head&gt;</span>

<span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">,</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>

        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;p3&quot;</span><span class="p">,</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
        <span class="p">},</span> <span class="mf">1000</span><span class="p">)</span>
    <span class="o">&lt;</span><span class="err">/script&gt;</span>
<span class="o">&lt;</span><span class="err">/body&gt;</span>

<span class="o">&lt;</span><span class="err">/html&gt;</span>
</code></pre></div>

<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4422131c0a174213822bb6ffe99fb8aa~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_19">总结</h3>
<ol>
<li><code>Date.now()</code>的基准是 <code>1970 年 1 月 1 日 00:00:00 (UTC)</code>, 而<code>Performance.now</code>是上下文创建。</li>
<li><code>Date.now()</code>返回的是整数，<code>Performance.now</code>返回的是double类型</li>
<li>理论上<code>Performance.now</code>精度更高</li>
</ol>
<h2 id="host-hostname">域名信息 <code>host</code>, <code>hostname</code></h2>
<h3 id="locationhost"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Location/host">location.host</a></h3>
<p>其包含：主机名，如果 URL 的端口号是非空的，还会跟上一个 ':' ，最后是 URL 的端口号</p>
<h3 id="locationhostname"><a href="">location.hostname</a></h3>
<p>返回域名</p>
<h3 id="_20">例子</h3>
<p>https与http的默认端口号，是不会被 host包含的，看下面的代码      </p>
<p><code>https://developer.mozilla.org:443</code> 的host是 <code>developer.mozilla.org</code>, 因为443是https的默认端口。</p>
<div class="codehilite"><pre><span></span><code>      <span class="kd">var</span> <span class="nx">anchor</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>

      <span class="nx">anchor</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">&quot;https://developer.mozilla.org:443/en-US/Location.host&quot;</span><span class="p">;</span>      
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">anchor</span><span class="p">.</span><span class="nx">host</span> <span class="o">==</span> <span class="s2">&quot;developer.mozilla.org:443&quot;</span><span class="p">)</span> <span class="c1">// false</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">anchor</span><span class="p">.</span><span class="nx">host</span> <span class="o">==</span> <span class="s2">&quot;developer.mozilla.org&quot;</span><span class="p">)</span> <span class="c1">// true</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">anchor</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">==</span> <span class="s2">&quot;developer.mozilla.org:443&quot;</span><span class="p">);</span> <span class="c1">// false</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">anchor</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">==</span> <span class="s2">&quot;developer.mozilla.org&quot;</span><span class="p">);</span>  <span class="c1">// true</span>

      <span class="nx">anchor</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">&quot;https://developer.mozilla.org:4097/en-US/Location.host&quot;</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">anchor</span><span class="p">.</span><span class="nx">host</span> <span class="o">==</span> <span class="s2">&quot;developer.mozilla.org:4097&quot;</span><span class="p">)</span>  <span class="c1">// true</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">anchor</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">==</span> <span class="s2">&quot;developer.mozilla.org&quot;</span><span class="p">)</span>  <span class="c1">// true</span>
</code></pre></div>

<h3 id="_21">总结</h3>
<ol>
<li>默认端口下， host等于hostname</li>
<li>host额外包含端口号</li>
</ol>
<h2 id="on-addeventlistener">事件注册  <code>on</code>, <code>addEventListener</code></h2>
<h3 id="_22">内联事件</h3>
<p>注册事件。</p>
<h3 id="eventtargetaddeventlistener"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener">EventTarget.addEventListener</a></h3>
<p>方法将指定的监听器注册到 EventTarget 上，当该对象触发指定的事件时，指定的回调函数就会被执行。</p>
<h3 id="_23">例子</h3>
<p>分别注册两次onclick和click事件，onclick只输出一次，click输出两次.</p>
<div class="codehilite"><pre><span></span><code>   <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;btn&quot;</span> <span class="p">&gt;</span>点我<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>

        <span class="kd">const</span> <span class="nx">btnEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;btn&quot;</span><span class="p">);</span>

        <span class="nx">btnEl</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;onclick&quot;</span><span class="p">,</span> <span class="mf">1</span><span class="p">);</span>
        <span class="nx">btnEl</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;onclick&quot;</span><span class="p">,</span> <span class="mf">1</span><span class="p">);</span>

        <span class="nx">btnEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="p">()=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="mf">1</span><span class="p">));</span>
        <span class="nx">btnEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="p">()=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="mf">2</span><span class="p">));</span>

    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/590f411f55b14d719109e3f95de92488~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_24">总结</h3>
<ol>
<li>内联事件是覆盖型，只能使用事件冒泡，<code>addEventListener</code>支持多个事件处理程序，并支持事件捕获。</li>
<li>
<p>内联事件<strong>特定情况下可以被Node.cloneNode复制</strong>，addEventListener的不行 <br />
     更多细节参见 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/cloneNode">Node.cloneNode</a></p>
</li>
<li>
<p>addEventListener为DOM2级事件绑定，onclick为DOM0级事件绑定</p>
</li>
</ol>
<h2 id="keypress-keydown">按键时间 <code>keypress</code>, <code>keydown</code></h2>
<h3 id="keypress"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/keypress_event">keypress</a></h3>
<p>当按下产生字符值的键时触发按键事件。产生字符值的键的示例有字母键、数字键和标点键。不产生字符值的键的例子是修改键，如 Alt、 Shift、 Ctrl 或 Meta。   </p>
<p><strong>不再推荐使用此功能。尽管一些浏览器可能仍然支持它，但它可能已经从相关的 web 标准中删除</strong></p>
<h3 id="keydown"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/keydown_event">keydown</a></h3>
<p>与keypress事件不同，无论是否生成字符值，所有键都会触发 keydown 事件。</p>
<h3 id="_25">例子</h3>
<p>输入123，keydown和keypress的值keyCode一样</p>
<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a162cc35a5b403abc1186d191b041e5~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_26">总结</h3>
<ol>
<li>触发顺序keydown -&gt; keypress</li>
<li>keydown：当用户按下键盘上的<strong>任意键</strong>时触发；</li>
<li>keypress：当用户按下键盘上的<strong>字符键</strong>时触发； 对中文输入法支持不好，无法响应中文输入</li>
<li>keypress的keyCode与keydown不是很一致；</li>
</ol>
<h2 id="deferasync">异步加载脚本 <code>defer</code>,<code>async</code></h2>
<h3 id="defer">defer</h3>
<p>异步加载，按照加载顺序执行脚本的</p>
<h3 id="async">async</h3>
<p>异步加载，乱序执行脚本。</p>
<p>这个一图胜千文</p>
<p><img alt="image.png" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3069fcc6e9384d84a8b24518fa3dd7d2~tplv-k3u1fbpfcp-watermark.image" /></p>
<h3 id="_27">例子</h3>
<p>四个script标签，两个async，两个defer。 <br />
代码内容如下：
* async1： <code>console.log("async1");</code>
* async2： <code>console.log("async2");</code>
* defer1： <code>console.log("defer1");</code>
* defer2： <code>console.log("defer2");</code></p>
<div class="codehilite"><pre><span></span><code>    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;./async1.js&quot;</span> <span class="na">async</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        sdfsdfsdfsdfsdfsdfd
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;./async2.js&quot;</span> <span class="na">async</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;./defer1.js&quot;</span> <span class="na">defer</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;./defer2.js&quot;</span> <span class="na">defer</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p><img alt="image.png" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b125d532e5f4ec7bd543d2bdadc26d5~tplv-k3u1fbpfcp-watermark.image" /></p>
<p><img alt="image.png" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87db981f744d45d396fa41e3bcbfa7f8~tplv-k3u1fbpfcp-watermark.image" /></p>
<p>从上面可以看出，有时候 <code>async2</code>会比<code>async1</code>输出早，defer的输出也可能比async的输出早。
但是defer的输出一定 <code>defer1</code>然后<code>defer2</code></p>
<h3 id="_28">总结</h3>
<ol>
<li>都是异步加载，defer会按照加载顺序执行，async乱序执行</li>
</ol>
<blockquote>
<p><a href="https://www.cnblogs.com/fsjohnhuang/p/4319635.html">JS魔法堂：被玩坏的innerHTML、innerText、textContent和value属性</a> <br />
<a href="https://www.cnblogs.com/mq0036/p/10416717.html">keydown,keypress,keyup三者之间的区别</a>   </p>
</blockquote>
</body>
</html>
